<!DOCTYPE html>
<html lang="zh-TW">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width,initial-scale=1.0">
	<title>輕小說翻譯</title>
	<link rel="icon" href="images/favicon.jpg" type="image/jpg">
	<script src="libs/vue.global.js"></script>
	<script src="libs/marked.min.js"></script>
	<style>
		:root{
			--primary:#4a90e2;
			--primary-hover:#357abd;
			--bg:#fff;
			--text:#333;
			--text-muted:#666;
			--border:#ddd;
			--secondary:#f5f5f5;
			--shadow:0 2px 8px rgba(0,0,0,0.15);
			--fs:clamp(16px,4vw,18px);
			--lh:clamp(1.6,0.2vw,1.8);
			--br:8px;
			--sp:1rem;
			--content-width:80%;
			--transition-fast:all 0.2s ease;
			--transition-normal:all 0.3s ease;
		}
		:root[data-theme="dark"]{
			--primary:#64b5f6;
			--bg:#121212;
			--text:#e0e0e0;
			--text-muted:#999;
			--border:#333;
			--secondary:#1a1a1a;
		}
		*{
			margin:0;
			padding:0;
			box-sizing:border-box;
		}
		body{
			font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
			line-height:1.6;
			color:var(--text);
			background:var(--secondary);
			padding-top:60px;
			min-height:100vh;
			transition:var(--transition-normal);
		}
		.container{
			max-width:1200px;
			margin:var(--sp) auto;
			padding:20px;
		}
		.fixed-overlay{
			position:fixed;
			left:0;
			right:0;
			background:rgba(255,255,255,0.85);
			box-shadow:var(--shadow);
			padding:var(--sp);
			z-index:1000;
			transition:transform 0.3s;
		}
		[data-theme="dark"] .fixed-overlay{
			background:rgba(18,18,18,0.85);
		}
		.navbar{
			top:0;
		}
		.navbar.hidden{
			transform:translateY(-100%);
		}
		.nav-container{
			max-width:1200px;
			margin:0 auto;
			gap:var(--sp);
			display:flex;
			align-items:center;
			justify-content:space-between;
		}
		.nav-right{
			display:flex;
			align-items:center;
			gap:var(--sp);
		}
		.nav-title{
			color:var(--primary);
			text-decoration:none;
			font-size:1.3rem;
			font-weight:bold;
		}
		.dropdown{
			position:relative;
		}
		.dropdown-toggle{
			cursor:pointer;
			padding:0.5rem;
			display:flex;
			align-items:center;
			gap:0.5rem;
			color:var(--text);
			background:none;
			border:none;
			font-size:1rem;
		}
		.dropdown-toggle::after{
			content:'▼';
			font-size:0.8em;
			transition:transform 0.3s;
		}
		.dropdown-toggle.active::after{
			transform:rotate(180deg);
		}
		.dropdown-menu{
			position:fixed;
			background:var(--bg);
			min-width:160px;
			box-shadow:var(--shadow);
			border-radius:var(--br);
			opacity:0;
			visibility:hidden;
			transform:translateY(-10px);
			transition:var(--transition-normal);
			z-index:1002;
			padding:4px;
		}
		.dropdown-menu.show{
			opacity:1;
			visibility:visible;
			transform:translateY(0);
		}
		.dropdown-menu a{
			display:flex;
			justify-content:space-between;
			align-items:center;
			padding:0.8rem var(--sp);
			color:var(--text);
			text-decoration:none;
			transition:var(--transition-normal);
			cursor:pointer;
			border-radius:var(--br);
		}
		.dropdown-menu a:hover{
			background:var(--secondary);
			color:var(--primary);
		}
		.dropdown-menu a.active{
			background:var(--primary);
			color:white;
		}
		.dropdown-menu a.active:hover{
			background:var(--primary-hover);
		}
		.dropdown-menu .checkmark{
			font-weight:bold;
			font-size:1rem;
			margin-left:0.5rem;
		}
		.btn-base{
			padding:0.5rem var(--sp);
			border:none;
			border-radius:var(--br);
			cursor:pointer;
			transition:var(--transition-normal);
		}
		.btn-primary{
			background:var(--primary);
			color:white;
			min-width:80px;
		}
		.btn-primary:hover{
			background:var(--primary-hover);
		}
		.btn-primary:disabled{
			opacity:0.5;
			cursor:not-allowed;
		}
		.btn-transparent{
			background:transparent;
			min-width:auto;
			color:var(--text);
			display:flex;
			align-items:center;
		}
		.btn-transparent:hover{
			color:var(--primary);
		}
		.theme-toggle{
			background:none;
			border:none;
			color:var(--text);
			font-size:1.3rem;
			cursor:pointer;
			padding:0.5rem;
			transition:transform 0.3s;
			line-height:1;
		}
		.theme-toggle:hover{
			transform:rotate(360deg);
		}
		.content-grid{
			display:grid;
			grid-template-columns:repeat(auto-fill,minmax(200px,1fr));
			gap:calc(var(--sp)*2);
		}
		.card{
			background:var(--bg);
			border-radius:var(--br);
			overflow:hidden;
			box-shadow:var(--shadow);
			transition:var(--transition-fast);
			cursor:pointer;
			display:flex;
			flex-direction:column;
		}
		.card:hover{
			transform:translateY(-5px);
		}
		.card img{
			width:100%;
			aspect-ratio:0.7;
			object-fit:cover;
			object-position:center top;
		}
		.card-info{
			padding:var(--sp);
			flex:1;
			display:flex;
			flex-direction:column;
			justify-content:space-between;
		}
		.card-title{
			font-size:1.1rem;
			font-weight:bold;
			color:var(--text);
		}
		.card-footer{
			display:flex;
			justify-content:space-between;
			align-items:center;
			margin-top:0.5rem;
			font-size:0.8rem;
			color:var(--text-muted);
		}
		.novel-detail{
			background:var(--bg);
			border-radius:var(--br);
			padding:2rem;
		}
		.novel-info{
			display:grid;
			grid-template-columns:300px 1fr;
			gap:2rem;
		}
		.novel-cover{
			width:100%;
			border-radius:var(--br);
			cursor:pointer;
			transition:transform 0.3s ease,box-shadow 0.3s ease;
		}
		.novel-cover:hover{
			transform:scale(1.05);
			box-shadow:0 8px 25px rgba(0,0,0,0.2);
		}
		.novel-title{
			font-size:2.3rem;
			margin-bottom:var(--sp);
			color:var(--text);
		}
		.novel-metadata{
			margin-bottom:var(--sp);
			color:var(--text);
		}
		.novel-description{		
			line-height:1.8;
			white-space:pre-line;
		}
		.source-link{
			display:inline-block;
			padding:0.25rem 0.75rem;
			margin-left:0.5rem;
			border-radius:var(--br);
			color:var(--text);
			background:var(--secondary);
			text-decoration:none;
			transition:var(--transition-fast);
		}
		.source-link:hover{
			background:var(--primary-hover);
			color:#fff;
		}
		.chapter-list-container{
			margin-top:2rem;
		}
		.chapter-list-header{
			display:flex;
			justify-content:space-between;
			align-items:center;
			margin-bottom:var(--sp);
			padding-bottom:0.5rem;
			border-bottom:1px solid var(--border);
		}
		.chapter-list-header h3{
			margin:0;
			color:var(--text);
			font-size:1.3rem;
		}
		.chapter-sort-btn{
			background:none;
			border:1px solid var(--border);
			border-radius:var(--br);
			padding:0.4rem;
			cursor:pointer;
			color:var(--text);
			transition:var(--transition-fast);
			display:flex;
			align-items:center;
			justify-content:center;
		}
		.chapter-sort-btn:hover{
			background:var(--primary);
			color:white;
			border-color:var(--primary);
			transform:translateY(-1px);
		}
		.chapter-list{
			display:grid;
			grid-template-columns:repeat(auto-fill,minmax(150px,1fr));
			gap:var(--sp);
		}
		.chapter-item{
			background:var(--secondary);
			padding:var(--sp);
			border-radius:var(--br);
			cursor:pointer;
			transition:var(--transition-fast);
			display:flex;
			flex-direction:column;
			gap:0.5rem;
		}
		.chapter-item:hover,.chapter-item.read:hover{
			background:var(--primary);
			color:#fff;
			transform:translateY(-2px);
		}
		.chapter-item.read{
			opacity:0.5;
			border:1px solid rgba(128,128,128,0.3);
		}
		.chapter-title{
			font-weight:500;
			flex-grow:1;
		}
		.chapter-date{
			font-size:0.85rem;
			color:var(--text-muted);
		}
		.reader-container{
			width:var(--content-width);
			margin:4rem auto 5rem;
			padding:2rem;
			background:var(--bg);
			border-radius:var(--br);
			box-shadow:var(--shadow);
			font-size:var(--fs);
		}
		.novel-content{
			margin-bottom:2rem;
			line-height:var(--lh);
		}
		.novel-content p{
			margin-bottom:var(--sp);
		}
		.novel-content img{
			max-width:50%;
			height:auto;
			display:block;
			margin:var(--sp) auto;
			cursor:pointer;
			border-radius:var(--br);
		}
		.reader-controls{
			bottom:0;
			display:flex;
			justify-content:center;
			gap:var(--sp);
		}
		.reader-controls.hidden{
			transform:translateY(100%);
		}
		.reader-title{
			text-align:center;
			flex-grow:1;
		}
		.modal{
			position:fixed;
			bottom:60px;
			left:50%;
			transform:translate(-50%,200%);
			width:300px;
			background:var(--bg);
			border:1px solid var(--border);
			border-radius:var(--br);
			padding:1.5rem;
			color:var(--text);
			z-index:1001;
			transition:transform 0.3s;
			max-height:60vh;
			display:flex;
			flex-direction:column;
			box-shadow:var(--shadow);
			line-height:1.5;
		}
		.modal.active{
			transform:translate(-50%,0);
		}
		.modal-header{
			padding:0 0 var(--sp) 0;
			border-bottom:1px solid var(--border);
			font-weight:bold;
			text-align:center;
			display:flex;
			justify-content:center;
			align-items:center;
			position:relative;
		}
		.modal-sort-btn{
			position:absolute;
			right:0;
			padding:0.3rem;
			font-size:0.9rem;
		}
		.modal-group{
			overflow-y:auto;
			flex:1;
			margin:0;
			padding:var(--sp) 0;
		}
		.modal-group label{
			display:block;
			margin-bottom:0.5rem;
			color:var(--text);
		}
		.modal-group input[type="range"]{
			width:100%;
			accent-color:var(--primary);
		}
		.modal-group input[type="checkbox"]{
			margin-right:0.5rem;
			accent-color:var(--primary);
		}
		.modal .chapter-item.current{
			background:#bbdefb;
			color:#000;
		}
		[data-theme="dark"] .modal .chapter-item.current{
			background:#1976d2;
			color:#fff;
		}
		.lightbox{
			position:fixed;
			inset:0;
			background:rgba(0,0,0,0.9);
			display:flex;
			justify-content:center;
			align-items:center;
			z-index:2000;
			opacity:0;
			visibility:hidden;
			pointer-events:none;
			transition:opacity 0.3s, visibility 0s 0.3s;
		}
		.lightbox.active{
			visibility:visible;
			opacity:1;
			pointer-events:auto;
			transition:opacity 0.3s, visibility 0s 0s;
		}
		.lightbox-content{
			position:relative;
			max-width:95%;
			max-height:85vh;
		}
		.lightbox img{
			max-width:100%;
			max-height:85vh;
			object-fit:contain;
		}
		.close-lightbox{
			position:absolute;
			top:-40px;
			right:0;
			color:white;
			font-size:24px;
			cursor:pointer;
			background:none;
			border:none;
			padding:8px;
		}
		.loading-overlay{
			position:fixed;
			inset:0;
			background:rgba(0,0,0,0.7);
			display:none;
			justify-content:center;
			align-items:center;
			z-index:9999;
		}
		.loading-overlay.show{
			display:flex;
		}
		.loading-spinner{
			width:50px;
			height:50px;
			border:4px solid rgba(255,255,255,0.3);
			border-top:4px solid white;
			border-radius:50%;
			animation:spin 1s linear infinite;
		}
		@keyframes spin{
			0%{transform:rotate(0deg)}
			100%{transform:rotate(360deg)}
		}
		.footer{
			background:var(--bg);
			border-top:1px solid var(--border);
			padding:2rem 0;
			margin-top:3rem;
			text-align:center;
			color:var(--text-muted);
		}
		.footer-content{
			max-width:1200px;
			margin:0 auto;
			padding:0 var(--sp);
		}
		.footer-text{
			font-size:0.9rem;
			line-height:1.6;
		}
		.desktop-only{
			display:block;
		}
		@media (max-width:768px){
			*{
				user-select:none;
			}
			.desktop-only{
				display:none;
			}
			.navbar{
				padding:clamp(0.5rem,2vw,0.8rem);
			}
			.nav-title{
				font-size:clamp(1rem,4vw,1.3rem);
			}
			.container{
				padding:clamp(8px,2vw,16px);
			}
			.content-grid{
				grid-template-columns:repeat(auto-fit,minmax(clamp(140px,35vw,180px),1fr));
				gap:clamp(18px,4.5vw,36px);
				padding:0 clamp(4px,1vw,12px);
			}
			.card-title{
				font-size:clamp(0.9rem,3vw,1.1rem);
			}
			.card-footer{
				font-size:clamp(0.7rem,2vw,0.8rem);
			}
			.novel-info{
				grid-template-columns:clamp(120px,30vw,200px) 1fr;
				gap:clamp(0.8rem,2vw,1.5rem);
			}
			.novel-title{
				font-size:clamp(1.2rem,5vw,2rem);
			}
			.chapter-list{
				grid-template-columns:repeat(auto-fill,minmax(clamp(80px,20vw,140px),1fr));
			}
			.chapter-title{
				font-size:clamp(0.8rem,2.5vw,1rem);
			}
			.reader-container{
				width:100%;
				margin:clamp(4px,1vw,8px) 0 clamp(60px,15vw,80px);
				padding:clamp(0.5rem,2vw,1rem);
				border-radius:0;
				box-shadow:none;
			}
			.reader-controls{
				padding:clamp(0.5rem,2vw,1rem);
			}
			.btn-primary{
				padding:clamp(0.3rem,1vw,0.5rem) clamp(0.5rem,2vw,1rem);
				font-size:clamp(0.8rem,2.5vw,1rem);
				min-width:clamp(60px,15vw,80px);
			}
			.modal{
				width:clamp(280px,85vw,350px);
				max-width:90vw;
			}
			.footer{
				padding:clamp(1rem,4vw,2rem) 0;
				margin-top:clamp(1.5rem,4vw,3rem);
			}
			.footer-text{
				font-size:clamp(0.8rem,2.5vw,0.9rem);
			}
			.chapter-list-header h3{
				font-size:clamp(1rem,4vw,1.3rem);
			}
			.chapter-sort-btn{
				padding:clamp(0.25rem,1vw,0.4rem);
			}
			.modal-sort-btn{
				padding:clamp(0.2rem,1vw,0.3rem);
			}
		}
	</style>
</head>
<body>
	<div id="app">
		<nav class="navbar fixed-overlay" v-show="currentPage!=='reader'">
			<div class="nav-container">
				<div class="nav-left">
					<button v-if="currentPage==='detail'" class="btn-base btn-transparent" @click="goToHome">
						<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
							<path d="M19 12H5M12 19l-7-7 7-7"/>
						</svg>
					</button>
					<a v-if="currentPage!=='detail'" class="nav-title" @click="goToHome">輕小說翻譯</a>
				</div>
				<div class="nav-right">
					<div class="dropdown" v-show="currentPage==='list'" @mouseenter="handleDropdownMouseEnter" @mouseleave="handleDropdownMouseLeave">
						<button ref="dropdownToggle" class="dropdown-toggle" @click="toggleSortDropdown" :class="{active:activeDropdown==='sort'}">
							<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
								<path d="M4 7h10M4 12h8M4 17h6"></path>
								<path d="M17 13l3 3l3-3"></path>
								<path d="M20 8v8"></path>
							</svg>
							<span>{{currentSortLabel}}</span>
						</button>
						<div class="dropdown-menu" :class="{show:activeDropdown==='sort'}">
							<a v-for="option in sortOptions" :key="option.value" @click="handleSortChange(option)" :class="{active:currentSort===option.value}">
								<span>{{option.label}}</span>
								<span v-if="currentSort===option.value" class="checkmark">✓</span>
							</a>
						</div>
					</div>
					<button class="theme-toggle" @click="isDarkMode=!isDarkMode">
						{{isDarkMode?'🌜':'🌞'}}
					</button>
				</div>
			</div>
		</nav>
		<main class="container" v-show="currentPage==='list'">
			<section class="content-grid">
				<article v-for="item in sortedNovelList" :key="item.title" class="card" @click="goToDetail(item)">
					<img :src="item.coverUrl" :alt="item.title" @error="handleImageError">
					<div class="card-info">
						<div class="card-title">{{item.title}}</div>
						<div class="card-footer">
							<span>{{item.author}}</span>
							<span>{{formatDate(item.lastUpdated,'list')}}</span>
						</div>
					</div>
				</article>
			</section>
		</main>
		<main class="container" v-show="currentPage==='detail'">
			<article class="novel-detail">
				<div class="novel-info">
					<img :src="getCoverUrl()" :alt="selectedNovel?.title" class="novel-cover" @click="openLightbox(getCoverUrl())" @error="handleImageError">
					<div>
						<h1 class="novel-title">{{selectedNovel?.title}}</h1>
						<div class="novel-metadata">
							<p><strong>作者：</strong>{{selectedNovel?.author}}</p>
							<p><strong>類型：</strong>{{selectedNovel?.genres}}</p>
							<p class="source-links" v-if="selectedNovel?.sourceLinks&&Object.keys(selectedNovel.sourceLinks).length">
								<strong>原連結：</strong>
								<a v-for="(link,key) in selectedNovel.sourceLinks" :key="key" :href="link" target="_blank" class="source-link">{{getSourceLinkName(key)}}</a>
							</p>
						</div>
						<div class="novel-description" v-if="parsedDescription" v-html="parsedDescription"></div>
					</div>
				</div>
				<div class="chapter-list-container">
					<div class="chapter-list-header">
						<h3>章節列表</h3>
						<button class="chapter-sort-btn" @click="toggleChapterSort" :title="chapterSortOrder==='asc'?'舊章節在前（升序）':'新章節在前（降序）'">
							<svg v-if="chapterSortOrder==='desc'" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
								<path d="M7 14l5-5 5 5"/>
								<path d="M12 19V9"/>
							</svg>
							<svg v-else width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
								<path d="M17 10l-5 5-5-5"/>
								<path d="M12 5v10"/>
							</svg>
						</button>
					</div>
					<div class="chapter-list">
						<article v-for="chapter in chaptersWithDates" :key="chapter.number" class="chapter-item" :class="{read:isChapterRead(chapter.number)}" @click="goToChapter(chapter.number,false)">
							<div class="chapter-title">{{chapter.title}}</div>
							<div class="chapter-date">{{formatDate(chapter.date)}}</div>
						</article>
					</div>
				</div>
			</article>
		</main>
		<footer class="footer" v-show="currentPage!=='reader'">
			<div class="footer-content">
				<div class="footer-text">
					<p>所有作品版權歸原作者所有，本站僅供學習交流使用</p>
				</div>
			</div>
		</footer>
		<main v-show="currentPage==='reader'">
			<nav class="navbar fixed-overlay" :class="{hidden:hideControls}">
				<div class="nav-container">
					<button class="btn-base btn-transparent" @click="goBackToDetail">
						<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
							<path d="M19 12H5M12 19l-7-7 7-7"/>
						</svg>
					</button>
					<div class="reader-title">{{currentChapter?.title}}</div>
				</div>
			</nav>
			<div class="reader-container">
				<article ref="novelContent" class="novel-content" v-html="parsedContent"></article>
			</div>
			<div class="reader-controls fixed-overlay" :class="{hidden:hideControls}">
				<button class="btn-base btn-primary" @click="navigateChapter('prev')" :disabled="!hasPrevious||isLoading">上一話</button>
				<button class="btn-base btn-primary" @click="toggleModal('showChapterMenu')" :disabled="isLoading">目錄</button>
				<button class="btn-base btn-primary" @click="toggleModal('showSettings')" :disabled="isLoading">設置</button>
				<button class="btn-base btn-primary" @click="navigateChapter('next')" :disabled="!hasNext||isLoading">下一話</button>
			</div>
			<div class="modal" :class="{active:showModal}">
				<div class="modal-header">
					<span>{{showSettings?'閱讀設置':'章節目錄'}}</span>
					<button v-if="showChapterMenu" class="chapter-sort-btn modal-sort-btn" @click.stop="toggleChapterSort" :title="chapterSortOrder==='asc'?'舊章節在前（升序）':'新章節在前（降序）'">
						<svg v-if="chapterSortOrder==='desc'" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
							<path d="M7 14l5-5 5 5"/>
							<path d="M12 19V9"/>
						</svg>
						<svg v-else width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
							<path d="M17 10l-5 5-5-5"/>
							<path d="M12 5v10"/>
						</svg>
					</button>
				</div>
				<div class="modal-group" v-if="showSettings">
					<label>字體大小: {{fontSize}}px</label>
					<input type="range" v-model="fontSize" min="14" max="24" step="1" @mousedown="onSettingsInputStart" @mouseup="onSettingsInputEnd" @touchstart="onSettingsInputStart" @touchend="onSettingsInputEnd">
					<label>行距: {{lineHeight}}</label>
					<input type="range" v-model="lineHeight" min="1.5" max="2.5" step="0.1" @mousedown="onSettingsInputStart" @mouseup="onSettingsInputEnd" @touchstart="onSettingsInputStart" @touchend="onSettingsInputEnd">
					<div class="desktop-only">
						<label>內容寬度: {{contentWidth}}%</label>
						<input type="range" v-model="contentWidth" min="50" max="100" step="5" @mousedown="onSettingsInputStart" @mouseup="onSettingsInputEnd" @touchstart="onSettingsInputStart" @touchend="onSettingsInputEnd">
					</div>
					<label><input type="checkbox" v-model="isDarkMode">夜間模式</label>
				</div>
				<div class="modal-group" v-if="showChapterMenu">
					<div v-for="chapter in sortedAllChapters" :key="chapter.number" class="chapter-item" :class="{current:chapter.number===currentChapter?.number,read:isChapterRead(chapter.number)}" @click="goToChapter(chapter.number,true)">
						<div>{{chapter.title}}</div>
					</div>
				</div>
			</div>
		</main>
		<div class="lightbox" :class="{active:isLightboxActive}" @click="isLightboxActive=false">
			<div class="lightbox-content">
				<button class="close-lightbox" @click.stop="isLightboxActive=false">✕</button>
				<img :src="lightboxImage" :alt="currentChapter?.title+ ' - 插圖'||selectedNovel?.title+ ' - 插圖'" @click.stop>
			</div>
		</div>
		<div class="loading-overlay" :class="{show:isLoading}">
			<div style="text-align:center">
				<div class="loading-spinner"></div>
				<div style="color:white;margin-top:var(--sp);font-size:1.1rem">載入中...</div>
			</div>
		</div>
	</div>
	<script>
		const {createApp}=Vue;
		createApp({
			data(){
				return{
					currentPage:'list',
					novelList:[],
					selectedNovel:null,
					selectedNovelData:null,
					allChapters:[],
					currentChapter:null,
					chapterContent:'',
					isDarkMode:localStorage.getItem('theme')==='dark',
					fontSize:parseInt(localStorage.getItem('font_size'))||18,
					lineHeight:parseFloat(localStorage.getItem('line_height'))||1.8,
					contentWidth:parseInt(localStorage.getItem('content_width'))||80,
					currentSort:localStorage.getItem('content_sort')||'lastUpdated',
					sortOptions:[
						{value:'lastUpdated',label:'最新更新'},  
						{value:'chapterCount',label:'章節數'},   
						{value:'wordCount',label:'文字數'}       
					],
					chapterSortOrder:localStorage.getItem('chapter_sort_order')||'desc',
					activeDropdown:null,
					isLoading:false,
					hideControls:false,
					showSettings:false,
					showChapterMenu:false,
					isLightboxActive:false,
					lightboxImage:null,
				}
			},
			computed:{
				novelKey(){
					return this.selectedNovel?.title?.replace(/[《》]/g,'')||'';
				},
				showModal(){
					return this.showSettings||this.showChapterMenu;
				},
				currentSortLabel(){
					return this.sortOptions.find(opt=>opt.value===this.currentSort)?.label||'排序';
				},
				sortedNovelList(){
					return[...this.novelList].sort((a,b)=>{
						switch(this.currentSort){
							case'lastUpdated':
								return new Date(b.lastUpdated)-new Date(a.lastUpdated);
							case'chapterCount':
								return(b.chapters||[]).length-(a.chapters||[]).length;
							case'wordCount':
								return(b.totalWordCount||0)-(a.totalWordCount||0);
							default:
								return 0;
						}
					});
				},
				chaptersWithDates(){
					return [...this.allChapters].sort((a,b)=>{
						return this.chapterSortOrder==='asc'?a.number-b.number:b.number-a.number;
					});
				},
				sortedAllChapters(){
					return [...this.allChapters].sort((a,b)=>{
						return this.chapterSortOrder==='asc'?a.number-b.number:b.number-a.number;
					});
				},
				parsedDescription(){
					return this.selectedNovel?.description?marked.parse(this.selectedNovel.description):'';
				},
				parsedContent(){
					return this.chapterContent?marked.parse(this.chapterContent):'';
				},
				hasNext(){
					return this.allChapters.some(chapter=>chapter.number>this.currentChapter?.number);
				},
				hasPrevious(){
					return this.allChapters.some(chapter=>chapter.number<this.currentChapter?.number);
				}
			},
			watch:{
				isDarkMode(newValue){
					const theme=newValue?'dark':'light';
					document.documentElement.setAttribute('data-theme',theme);
					localStorage.setItem('theme',theme);
				},
				fontSize(newValue){
					this.updateSetting('--fs',`${newValue}px`,'font_size',newValue);
				},
				lineHeight(newValue){
					this.updateSetting('--lh',newValue,'line_height',newValue);
				},
				contentWidth(newValue){
					this.updateSetting('--content-width',`${newValue}%`,'content_width',newValue);
				},
				currentPage(newValue){
					if(newValue==='reader'){
						this.$nextTick(()=>{
							window.addEventListener('scroll',this.handleScroll);
							this.setupImageViewer();
						});
					}else{
						window.removeEventListener('scroll',this.handleScroll);
						this.hideControls=false;
					}
				}
			},
			methods:{
				updateSetting(cssVar,cssValue,storageKey,storageValue){
					this._adjustingSettings=true;
					document.documentElement.style.setProperty(cssVar,cssValue);
					localStorage.setItem(storageKey,storageValue);
					clearTimeout(this._adjustingTimer);
					this._adjustingTimer=setTimeout(()=>this._adjustingSettings=false,500);
				},
				async fetchNovelList(){
					try{
						const response=await fetch('輕小說翻譯/novels.json');
						const data=await response.json();
						this.novelList=data.novels.map(novel=>{
							const titleWithBrackets=novel.title.match(/^《.*》$/)?novel.title:`《${novel.title}》`;
							return{
								title:titleWithBrackets,
								coverUrl:`輕小說翻譯/${encodeURIComponent(titleWithBrackets)}/cover.jpg`,
								lastUpdated:novel.lastUpdated||new Date().toISOString(),
								author:novel.author||'未知作者',
								chapters:novel.chapters||[],
								totalWordCount:novel.totalWordCount||0,
								originalData:novel
							};
						});
					}catch(error){
						console.error('讀取小說列表失敗:',error);
					}
				},
				updateUrl(page,params={}){
					const searchParams=new URLSearchParams();
					if(page==='detail'&&params.title){
						searchParams.set('title',params.title);
					}else if(page==='reader'&&params.title&&params.chapter){
						searchParams.set('title',params.title);
						searchParams.set('chapter',params.chapter.toString());
					}
					const queryString=searchParams.toString();
					const newUrl=queryString?`${window.location.pathname}?${queryString}`:window.location.pathname;
					window.history.pushState({page,params},'',newUrl);
					let title='輕小說翻譯';
					if(page==='detail'&&params.title){
						title=`${params.title} - 輕小說翻譯`;
					}
					else if(page==='reader'&&params.title&&this.currentChapter){
						title=`${this.currentChapter.title} - ${params.title} - 輕小說翻譯`;
					}
					document.title=title;
				},
				async handleUrlParams(){
					const urlParams=new URLSearchParams(window.location.search);
					const titleParam=urlParams.get('title');
					const chapterParam=urlParams.get('chapter');
					if(!titleParam)return this.goToHome();
					if(this.novelList.length===0){
						await this.fetchNovelList();
					}
					const novel=this.novelList.find(n=>n.title===titleParam);
					if(!novel)return this.goToHome();
					this.setCurrentNovel(novel);
					if(chapterParam){
						const chapterNumber=parseFloat(chapterParam);
						this.currentChapter=this.findChapter(chapterNumber);
						if(this.currentChapter){
							this.currentPage='reader';
							await this.loadChapterContent();
						}else{
							this.currentPage='detail';
							this.updateUrl('detail',{title:titleParam});
						}
					}else{
						this.currentPage='detail';
					}
				},
				goToHome(){
					this.currentPage='list';
					this.selectedNovel=null;
					this.currentChapter=null;
					this.updateUrl('list');
					window.scrollTo(0,0);
				},
				goToDetail(novel){
					this.setCurrentNovel(novel);
					this.currentPage='detail';
					this.updateUrl('detail',{title:novel.title});
					window.scrollTo(0,0);
				},
				goToChapter(chapterNumber,fromReader=false){
					if(fromReader&&chapterNumber===this.currentChapter?.number){
						this.closeAllModals();
						return;
					}
					if(fromReader)this.saveScrollPosition();
					this.currentChapter=this.findChapter(chapterNumber);
					this.loadChapterContent();
					if(!fromReader){
						this.currentPage='reader';
					}
					this.closeAllModals();
					this.updateUrl('reader',{title:this.selectedNovel.title,chapter:chapterNumber});
				},
				goBackToDetail(){
					this.saveScrollPosition();
					this.currentPage='detail';
					this.hideControls=false;
					this.closeAllModals();
					this.updateUrl('detail',{title:this.selectedNovel.title});
					window.scrollTo(0,0);
				},
				setCurrentNovel(novel){
					this.selectedNovel=novel;
					this.selectedNovelData=novel.originalData;
					this.setupNovelDetail();
				},
				setupNovelDetail(){
					if(!this.selectedNovelData)return;
					const sourceLinks={};
					if(this.selectedNovelData.originalUrl){
						const urls=this.selectedNovelData.originalUrl.split('、');
						urls.forEach(url=>{
							if(url.includes('kakuyomu.jp')){
								sourceLinks.kakuyomu=url;
							}
							else if(url.includes('syosetu.com')){
								sourceLinks.syosetu=url;
							}
							else{
								sourceLinks.japanese=url;
							}
						});
					}
					this.selectedNovel={
						...this.selectedNovel,
						genres:this.selectedNovelData.tags?.join(', ')||'',
						description:this.selectedNovelData.description||'',
						sourceLinks:sourceLinks
					};
					this.allChapters=this.selectedNovelData.chapters
						.filter(chapter=>chapter.id>=0)
						.map(chapter=>({
							number:chapter.id,
							title:chapter.title,
							filename:`${chapter.id} ${chapter.title.replace(/^第\d+\.?\d*話\s+/,'')}.md`,
							date:new Date(chapter.lastUpdated).toISOString().split('T')[0]
						}))
						.sort((a,b)=>a.number-b.number);
				},
				getCoverUrl(){
					return this.selectedNovel?`輕小說翻譯/${encodeURIComponent(this.selectedNovel.title)}/cover.jpg`:'';
				},
				getSourceLinkName(key){
					const names={
						kakuyomu:'カクヨム',
						syosetu:'小説家になろう',
						japanese:'日文原文'
					};
					return names[key]||key;
				},
				formatDate(dateStr,format='detail'){
					if(!dateStr)return'';
					const date=new Date(dateStr);
					return format==='list'?
						date.toLocaleDateString():
						date.toLocaleDateString('zh-TW',{year:'numeric',month:'2-digit',day:'2-digit'}).replace(/\//g,'-');
				},
				async loadChapterContent(){
					this.isLoading=true;
					this._loadingContent=true;
					try{
						const folderPath=encodeURIComponent(this.selectedNovel.title);
						const encodedFilename=encodeURIComponent(this.currentChapter.filename);
						const filename=`輕小說翻譯/${folderPath}/${encodedFilename}`;
						const response=await fetch(filename);
						if(!response.ok){
							throw new Error(`HTTP ${response.status}: ${response.statusText}`);
						}
						this.chapterContent=await response.text();
						this.$nextTick(()=>{
							window.scrollTo(0,0);
							this.setupImageViewer();
							this.markAsRead();
							this.restoreScrollPosition();
							this._loadingContent=false;
						});
					}catch(error){
						console.error('讀取章節內容失敗:',error);
						alert(`讀取章節內容失敗: ${error.message}`);
						this._loadingContent=false;
					}finally{
						this.isLoading=false;
					}
				},
				setupImageViewer(){
					const content=this.$refs.novelContent;
					if(content){
						content.removeEventListener('click',this.handleContentClick);
						content.addEventListener('click',this.handleContentClick);
					}
				},
				handleContentClick(e){
					if(e.target.tagName==='IMG'){
						this.lightboxImage=e.target.src;
						this.isLightboxActive=true;
						this.closeAllModals();
					}
				},
				handleScroll(){
					if(this._adjustingSettings)return;
					const st=window.pageYOffset||document.documentElement.scrollTop;
					const isAtBottom=window.innerHeight+window.pageYOffset>=document.body.offsetHeight-15;
					const lastScrollTop=this._lastScrollTop||0;
					const scrollDelta=Math.abs(st-lastScrollTop);
					if(scrollDelta<10)return;
					const isScrollingDown=st>lastScrollTop;
					if(isScrollingDown&&!isAtBottom&&st>100){
						this.hideControls=true;
						this.closeAllModals();
					}
					else if(!isScrollingDown||isAtBottom||st<=50){
						this.hideControls=false;
					}
					this._lastScrollTop=st;
					this.saveScrollPosition();
				},
				saveScrollPosition(){
					if(!this.selectedNovel||!this.currentChapter)return;
					if(this._loadingContent)return;
					try{
						const scrollPositions=JSON.parse(localStorage.getItem('scroll_positions'))||{};
						const novelPositions=scrollPositions[this.novelKey]||{};
						const currentPosition=window.pageYOffset;
						novelPositions[this.currentChapter.number]=currentPosition;
						scrollPositions[this.novelKey]=novelPositions;
						localStorage.setItem('scroll_positions',JSON.stringify(scrollPositions));
					}catch{
					}
				},
				restoreScrollPosition(){	
					if(!this.selectedNovel||!this.currentChapter)return;
					try{
						const scrollPositions=JSON.parse(localStorage.getItem('scroll_positions'))||{};
						const novelPositions=scrollPositions[this.novelKey]||{};
						const savedPosition=novelPositions[this.currentChapter.number];
						if(savedPosition!==undefined&&savedPosition>0){
							setTimeout(()=>{
								window.scrollTo({
									top: parseInt(savedPosition),
									left: 0,
									behavior: 'smooth'
								});
							},100);
						}
					}catch(error){
					}
				},
				navigateChapter(direction){
					if(this.isLoading)return;
					const currentIndex=this.allChapters.findIndex(ch=>ch.number===this.currentChapter.number);
					const targetIndex=direction==='next'?currentIndex+1:currentIndex-1;
					const targetChapter=this.allChapters[targetIndex];
					if(targetChapter){
						this.goToChapter(targetChapter.number,true);
					}
				},
				toggleSortDropdown(){
					this.setDropdown(this.activeDropdown?null:'sort');
				},
				toggleModal(type){
					if(this[type]){
						this[type]=false;
					}else{
						this.closeAllModals();
						this[type]=true;
						if(type==='showChapterMenu'){
							this.$nextTick(()=>{
								const currentElement=document.querySelector('.modal .chapter-item.current');
								currentElement?.scrollIntoView({behavior:'smooth',block:'center'});
							});
						}
					}
				},
				openLightbox(imageUrl){
					this.lightboxImage=imageUrl;
					this.isLightboxActive=true;
				},
				handleImageError(event){
					event.target.src='images/ImageError.png';
				},
				handleSortChange(sortOption){
					this.currentSort=sortOption.value;
					localStorage.setItem('content_sort',sortOption.value);
					this.activeDropdown=null;
				},
				markAsRead(){
					if(!this.selectedNovel||!this.currentChapter)return;
					let readChapters;
					try {
						readChapters = JSON.parse(localStorage.getItem('read_chapters')) || {};
					} catch {
						readChapters = {};
					}
					if(!readChapters[this.novelKey]){
						readChapters[this.novelKey]=[];
					}
					if(!readChapters[this.novelKey].includes(this.currentChapter.number)){
						readChapters[this.novelKey].push(this.currentChapter.number);
						try {
							localStorage.setItem('read_chapters', JSON.stringify(readChapters));
						} catch {
						}
					}
				},
				isChapterRead(chapterNumber){
					if(!this.selectedNovel)return false;
					let readChapters;
					try {
						readChapters = JSON.parse(localStorage.getItem('read_chapters')) || {};
					} catch {
						readChapters = {};
					}
					return readChapters[this.novelKey]?.includes(chapterNumber)||false;
				},
				closeAllModals(){
					this.showSettings=false;
					this.showChapterMenu=false;
				},
				findChapter(chapterNumber){
					return this.allChapters.find(ch=>ch.number===chapterNumber);
				},
				onSettingsInputStart(){
					this._adjustingSettings=true;
					clearTimeout(this._adjustingTimer);
				},
				onSettingsInputEnd(){
					clearTimeout(this._adjustingTimer);
					this._adjustingTimer=setTimeout(()=>this._adjustingSettings=false,500);
				},
				handleDropdownMouseEnter(){
					this.setDropdown('sort');
				},
				handleDropdownMouseLeave(){
					this.setDropdown(null,150);
				},
				setDropdown(value,delay=0){
					clearTimeout(this._dropdownTimer);
					if(delay){
						this._dropdownTimer=setTimeout(()=>this.activeDropdown=value,delay);
					}else{
						this.activeDropdown=value;
					}
				},
				toggleChapterSort(){
					this.chapterSortOrder=this.chapterSortOrder==='asc'?'desc':'asc';
					localStorage.setItem('chapter_sort_order',this.chapterSortOrder);
					if(this.showChapterMenu&&this.currentChapter){
						this.$nextTick(()=>{
							const currentElement=document.querySelector('.modal .chapter-item.current');
							currentElement?.scrollIntoView({behavior:'smooth',block:'center'});
						});
					}
				}
			},
			mounted(){
				const theme=localStorage.getItem('theme')||'light';
				document.documentElement.setAttribute('data-theme',theme);
				document.documentElement.style.setProperty('--fs',`${this.fontSize}px`);
				document.documentElement.style.setProperty('--lh',this.lineHeight);
				document.documentElement.style.setProperty('--content-width',`${this.contentWidth}%`);
				this.fetchNovelList().then(()=>this.handleUrlParams());
				const handlePopstate=()=>this.handleUrlParams();
				const handleKeydown=(e)=>{
					if(e.key==='Escape'){
						if(this.isLightboxActive){
							this.isLightboxActive=false;
						}
						else if(this.currentPage==='reader'){
							this.closeAllModals();
						}
					}
					else if(this.currentPage==='reader'&&!this.showSettings&&!this.showChapterMenu&&!this.isLightboxActive){
						if((e.key==='ArrowLeft'||e.key==='ArrowUp')&&this.hasPrevious){
							this.navigateChapter('prev');
						}
						else if((e.key==='ArrowRight'||e.key==='ArrowDown')&&this.hasNext){
							this.navigateChapter('next');
						}
					}
				};
				const handleDocumentClick=(e)=>{
					if(this.currentPage==='reader'&&!e.target.closest('.modal')&&!e.target.closest('.btn-primary')){
						this.closeAllModals();
						if(this.hideControls){
							this.hideControls=false;
						}
					}
					if(!e.target.closest('.dropdown')){
						this.activeDropdown=null;
					}
				};
				window.addEventListener('popstate',handlePopstate);
				document.addEventListener('click',handleDocumentClick);
				document.addEventListener('keydown',handleKeydown);
			}
		}).mount('#app');
	</script>
</body>
</html>