<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="射擊挑戰是一款考驗精準度與反應速度的網頁射擊遊戲。挑戰不同難度等級，累積連擊取得高分，支援多種遊戲模式，適合所有休閒遊戲愛好者。享受流暢的射擊體驗，挑戰你的極限！">
    <meta name="keywords" content="射擊遊戲, 射擊挑戰, 網頁遊戲, HTML5遊戲, 精準瞄準, 連擊系統, 計時挑戰, 反應訓練, 分數排行, 多種難度, 瞄準訓練, 休閒遊戲, 瀏覽器遊戲">
    
    <title>射擊挑戰 - 免費網頁射擊遊戲 | HTML5瞄準訓練遊戲</title>
    
    <!-- Firebase SDK v11 -->
    <script src="https://www.gstatic.com/firebasejs/11.9.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore-compat.js"></script>
    
    <link rel="icon" href="images/favicon.jpg" type="image/jpg">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: manipulation; 
            -webkit-user-select: none;  
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        body {
            font-family: '微軟正黑體', Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            width: 100vw;
            background-color: #1a1a2e;
            color: #fff;
            overflow: hidden; 
        }
        
        .game-container {
            position: relative;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #16213e, #0f3460);
            border: none;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .home-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #16213e, #0f3460);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            padding: 20px 20px;
            z-index: 20;
            transition: all 0.5s ease;
            overflow-y: auto;
            gap: 15px;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        
        .game-title {
            text-align: center;
            margin-bottom: 5px;
        }
        
        .game-title h1 {
            font-size: 52px;
            margin-bottom: 10px;
            color: #fff;
            text-shadow: 0 0 15px rgba(80, 140, 255, 0.7);
            animation: glow 2s ease-in-out infinite alternate;
        }
        
        @keyframes glow {
            from { text-shadow: 0 0 10px rgba(80, 140, 255, 0.7); }
            to { text-shadow: 0 0 20px rgba(80, 140, 255, 0.9), 0 0 30px rgba(80, 140, 255, 0.6); }
        }
        
        .subtitle {
            font-size: 22px;
            color: #e2e2e2;
            text-shadow: 0 0 5px rgba(0,0,0,0.5);
        }
        
        .game-menu {
            display: flex;
            flex-direction: column;
            gap: 16px;
            width: 280px;
        }
        
        .menu-button {
            background: linear-gradient(135deg, #4361ee, #3a0ca3);
            color: white;
            border: none;
            padding: 15px 20px;
            font-size: 18px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            width: 100%;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        
        .menu-button:hover {
            transform: translateY(-5px);
            box-shadow: 0 7px 14px rgba(0,0,0,0.3);
            background: linear-gradient(135deg, #4895ef, #3f37c9);
        }
        
        .menu-button:active {
            transform: translateY(-2px);
        }
        
        .game-info {
            text-align: center;
            margin-top: 30px;
            font-size: 16px;
            background-color: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 10px;
            width: 280px;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .mode-display, .high-score {
            margin: 8px 0;
        }
        
        .high-score span {
            color: #4cc9f0;
            font-weight: bold;
        }
        
        .player-name-input {
            margin: 8px 0;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .player-name-input label {
            font-size: 14px;
            color: #e2e2e2;
        }
        
        .player-name-input input {
            padding: 8px 12px;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 5px;
            background: rgba(0,0,0,0.3);
            color: white;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        .player-name-input input:focus {
            outline: none;
            border-color: #4cc9f0;
            box-shadow: 0 0 10px rgba(76, 201, 240, 0.3);
        }
        
        .player-name-input input::placeholder {
            color: rgba(255,255,255,0.5);
        }
        
        .footer {
            font-size: 14px;
            color: rgba(255,255,255,0.6);
            margin-top: 10px;
        }

        /* 首頁滾動條樣式 */
        .home-screen::-webkit-scrollbar {
            width: 8px;
        }
        
        .home-screen::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
        }
        
        .home-screen::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.3);
            border-radius: 10px;
        }
        
        .home-screen::-webkit-scrollbar-thumb:hover {
            background: rgba(255,255,255,0.4);
        }

        .instructions-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.95);
            color: white;
            display: none;
            flex-direction: column;
            align-items: center;
            padding: 20px 30px;
            z-index: 15;
            transition: all 0.5s ease;
        }
        
        .instructions-content {
            max-width: 600px;
            margin: 10px 0 20px 0;
            line-height: 1.6;
            max-height: 70vh;
            overflow-y: auto;
            padding: 0 15px;
            scrollbar-width: thin;
            scrollbar-color: rgba(255,255,255,0.3) rgba(0,0,0,0.2);
        }
        
        .instructions-content::-webkit-scrollbar {
            width: 8px;
        }
        
        .instructions-content::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
        }
        
        .instructions-content::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.3);
            border-radius: 10px;
        }
        
        .instructions-content::-webkit-scrollbar-thumb:hover {
            background: rgba(255,255,255,0.4);
        }
        
        .instructions-content h2 {
            margin: 20px 0 10px;
            color: #4cc9f0;
            font-size: 22px;
        }
        
        .instructions-content ul {
            margin-left: 20px;
            margin-top: 10px;
        }
        
        .instructions-content li {
            margin-bottom: 8px;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 15px;
        }

        .target {
            position: absolute;
            width: 100px;
            height: 180px;
            cursor: crosshair;
            display: none;
            transition: transform 0.2s ease;
            touch-action: none; 
        }
        
        .target.circle-target {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: radial-gradient(circle, white 10%, #4d96ff 10%, #4d96ff 30%, white 30%, white 50%, #3a84e8 50%, #3a84e8 70%, white 70%);
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            border: 2px solid rgba(255,255,255,0.7);
        }
        
        .target.circle-target:active {
            transform: scale(0.9);
        }
        
        .head {
            position: absolute;
            width: 40px;
            height: 40px;
            background-color: #4d96ff;
            border-radius: 50%;
            top: 0;
            left: 30px;
            transition: transform 0.1s;
            border: 2px solid #333;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        
        .head:active {
            transform: scale(0.9);
        }
        
        .body {
            position: absolute;
            width: 50px;
            height: 80px;
            background-color: #4d96ff;
            top: 40px;
            left: 25px;
            border-radius: 5px;
            border: 2px solid #333;
        }
        
        .arm-left, .arm-right {
            position: absolute;
            width: 15px;
            height: 60px;
            background-color: #4d96ff;
            top: 45px;
            border-radius: 5px;
            border: 2px solid #333;
        }
        
        .arm-left {
            left: 10px;
        }
        
        .arm-right {
            right: 10px;
        }
        
        .leg-left, .leg-right {
            position: absolute;
            width: 15px;
            height: 60px;
            background-color: #4d96ff;
            top: 120px;
            border-radius: 5px;
            border: 2px solid #333;
        }
        
        .leg-left {
            left: 25px;
        }
        
        .leg-right {
            right: 25px;
        }

        .info-panel {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 15px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), rgba(0,0,0,0.6));
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 18px;
            z-index: 5;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .time, .score {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .time i, .score i {
            font-size: 20px;
        }
        
        .time span, .score span {
            font-weight: bold;
            color: #4cc9f0;
        }
        
        .start-screen, .end-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(22, 33, 62, 0.9), rgba(15, 52, 96, 0.9));
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
            transition: all 0.5s ease;
        }
        
        .missed {
            opacity: 0.7;
            filter: grayscale(50%);
        }
        
        strong {
            color: #fff;
            background-color: #4361ee;
            padding: 0 5px;
            border-radius: 3px;
        }
        
        .end-screen {
            display: none;
        }
        
        .score-display {
            font-size: 64px;
            margin: 30px 0;
            text-shadow: 0 0 10px rgba(76, 201, 240, 0.7);
        }
        
        .stats {
            background-color: rgba(0,0,0,0.3);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            min-width: 300px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
        }
        
        .stat-value {
            font-weight: bold;
            color: #4cc9f0;
        }
        
        button {
            background: linear-gradient(135deg, #4361ee, #3a0ca3);
            color: white;
            border: none;
            padding: 15px 30px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 18px;
            margin: 10px 2px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 14px rgba(0,0,0,0.3);
            background: linear-gradient(135deg, #4895ef, #3f37c9);
        }
        
        button:active {
            transform: translateY(-1px);
        }
        
        .small-button {
            padding: 8px 12px;
            font-size: 14px;
            margin: 0 5px;
        }
        
        #end-game-button {
            background: linear-gradient(135deg, #ef476f, #d90429);
        }
        
        #end-game-button:hover {
            background: linear-gradient(135deg, #f25a82, #e71735);
        }
        
        .controls {
            display: flex;
            gap: 8px;
        }
        
        h1 {
            font-size: 40px;
            margin-bottom: 20px;
            text-shadow: 0 0 10px rgba(0,0,0,0.5);
        }

        .settings-panel {
            position: absolute;
            top: 60px;
            right: -300px;
            width: 280px;
            max-height: 80vh; 
            background: linear-gradient(135deg, rgba(22, 33, 62, 0.95), rgba(15, 52, 96, 0.95));
            padding: 20px;
            border-radius: 10px;
            z-index: 25;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            transition: right 0.4s ease;
            border: 1px solid rgba(255,255,255,0.1);
            overflow-y: auto; 
            scrollbar-width: thin; 
            scrollbar-color: rgba(255,255,255,0.3) rgba(0,0,0,0.2); 
        }

        .settings-panel::-webkit-scrollbar {
            width: 6px;
        }
        
        .settings-panel::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
        }
        
        .settings-panel::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.3);
            border-radius: 10px;
        }
        
        .settings-panel::-webkit-scrollbar-thumb:hover {
            background: rgba(255,255,255,0.4);
        }
        
        .settings-panel.show-settings {
            right: 10px !important;
        }

        .settings-toggle {
            position: absolute;
            top: 25px;
            right: 25px;
            background: linear-gradient(135deg, #4896ef, #4361ee);
            color: white;
            border: none;
            border-radius: 10px;
            width: auto;
            height: auto;
            padding: 8px 15px;
            z-index: 1000;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            box-shadow: 0 3px 8px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .settings-toggle::before {
            content: "⚙️";
            font-size: 18px;
        }
        
        .settings-toggle:hover {
            background: linear-gradient(135deg, #5ba3f0, #536cf5);
            transform: translateY(-2px);
            box-shadow: 0 5px 12px rgba(0,0,0,0.4);
        }
        
        .setting-item {
            margin: 15px 0;
        }
        
        .setting-item label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .difficulty-buttons {
            display: flex;
            gap: 8px;
        }
        
        .diff-button {
            flex: 1;
            padding: 8px 5px;
            font-size: 14px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .diff-button.active {
            background: linear-gradient(135deg, #4895ef, #3f37c9);
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        .move-type-buttons {
            display: flex;
            gap: 8px;
        }
        
        .move-button {
            flex: 1;
            padding: 8px 3px;
            font-size: 12px;
            background: rgba(128,128,128,0.3); 
            border: 1px solid rgba(255,255,255,0.2);
            color: rgba(255,255,255,0.6); 
            transition: all 0.3s ease;
            cursor: pointer;
            white-space: nowrap;
        }
        
        .move-button.active {
            background: linear-gradient(135deg, #4895ef, #3f37c9);
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            color: white; 
        }
        
        .move-button:hover {
            background: rgba(128,128,128,0.5); 
        }
        
        .move-button.active:hover {
            background: linear-gradient(135deg, #5ba3f0, #4361ee);
            transform: translateY(-2px);
        }

        .bullet-hole {
            position: absolute;
            width: 12px;
            height: 12px;
            background: radial-gradient(circle, rgba(0,0,0,0.8) 20%, rgba(50,50,50,0.8) 40%, transparent 70%);
            border-radius: 50%;
            z-index: 1;
            pointer-events: none;
            transform: translate(-50%, -50%);
            box-shadow: inset 0 0 2px rgba(0,0,0,0.8);
        }
        
        .hit-flash {
            animation: flash 0.2s ease-out;
        }
        
        @keyframes flash {
            0% { filter: brightness(1); }
            50% { filter: brightness(3); }
            100% { filter: brightness(1); }
        }
        
        .screen-shake {
            animation: shake 0.3s cubic-bezier(.36,.07,.19,.97) both;
        }
        
        @keyframes shake {
            10%, 90% { transform: translate(-1px, -1px); }
            20%, 80% { transform: translate(2px, 2px); }
            30%, 70% { transform: translate(-2px, -2px); }
            40%, 60% { transform: translate(2px, 2px); }
            50% { transform: translate(-2px, -2px); }
        }
        
        .screen-shake-light {
            animation: shake-light 0.2s cubic-bezier(.36,.07,.19,.97) both;
        }
        
        @keyframes shake-light {
            10%, 90% { transform: translate(-0.5px, -0.5px); }
            20%, 80% { transform: translate(1px, 1px); }
            30%, 70% { transform: translate(-1px, -1px); }
            40%, 60% { transform: translate(1px, 1px); }
            50% { transform: translate(-1px, -1px); }
        }

        .countdown {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 120px;
            font-weight: bold;
            color: white;
            text-shadow: 0 0 20px rgba(67, 97, 238, 0.8);
            z-index: 15;
            transition: all 0.3s ease;
        }
        
        .countdown-pulse {
            animation: pulse 0.9s cubic-bezier(0.5, 0, 0.5, 1);
            transform: translate(-50%, -50%) scale(1);
        }
        
        @keyframes pulse {
            0% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.2); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }

        .floating-text {
            position: absolute;
            color: white;
            font-size: 18px;
            font-weight: bold;
            pointer-events: none;
            z-index: 100;
            animation: float-up 1s ease-out forwards;
            transform: translate(-50%, -50%);
            text-shadow: 0 0 5px rgba(0,0,0,0.7);
        }
        
        .combo-text {
            color: #ffcc00;
            text-shadow: 0 0 5px rgba(255, 204, 0, 0.7);
        }
        
        .bonus-text {
            color: #ff3399;
            text-shadow: 0 0 5px rgba(255, 51, 153, 0.7);
        }
        
        .penalty-text {
            color: #ff3333;
            text-shadow: 0 0 5px rgba(255, 51, 51, 0.7);
            font-weight: bold;
        }
        
        @keyframes float-up {
            0% { transform: translate(-50%, -50%); opacity: 1; }
            100% { transform: translate(-50%, -100px); opacity: 0; }
        }

        .time-warning {
            animation: pulse-warning 1s infinite;
            color: #ff3333 !important;
        }
        
        @keyframes pulse-warning {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .new-record {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #f72585, #7209b7);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 24px;
            font-weight: bold;
            animation: bounce 2s infinite;
            box-shadow: 0 0 20px rgba(247, 37, 133, 0.7);
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateX(-50%) translateY(0); }
            40% { transform: translateX(-50%) translateY(-20px); }
            60% { transform: translateX(-50%) translateY(-10px); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in-out forwards;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .slide-in {
            animation: slideIn 0.5s ease-out forwards;
        }
        
        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .particle {
            position: absolute;
            background-color: #fff;
            border-radius: 50%;
            pointer-events: none;
            z-index: 100;
        }

        .combo-display {
            position: absolute;
            right: 15px;
            bottom: 15px;
            background: rgba(0,0,0,0.6);
            padding: 8px 15px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
            z-index: 5;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }
        
        .combo-count {
            font-weight: bold;
            color: #ffcc00;
        }

        .game-container {
            cursor: crosshair;
        }

        .leaderboard-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #16213e, #0f3460);
            color: white;
            display: none;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            z-index: 20;
            overflow-y: auto;
        }
        
        .leaderboard-screen h1 {
            font-size: 28px;
            margin-bottom: 20px;
            color: #fff;
            text-shadow: 0 0 15px rgba(80, 140, 255, 0.7);
        }
        
        .leaderboard-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .filter-button {
            background: rgba(255,255,255,0.1);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        
        .filter-button:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }
        
        .filter-button.active {
            background: linear-gradient(135deg, #4361ee, #3a0ca3);
            border-color: #4361ee;
            box-shadow: 0 0 10px rgba(67, 97, 238, 0.5);
        }
        
        .leaderboard-content {
            width: 100%;
            max-width: 600px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 12px;
            margin-bottom: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            border-left: 4px solid #4cc9f0;
            transition: all 0.3s ease;
        }
        
        .leaderboard-item:hover {
            background: rgba(255,255,255,0.1);
            transform: translateX(5px);
        }
        
        .rank-number {
            background: linear-gradient(135deg, #f72585, #7209b7);
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            margin-right: 15px;
            flex-shrink: 0;
        }
        
        .rank-number.top-rank {
            background: linear-gradient(135deg, #ffd60a, #ff8500);
            box-shadow: 0 0 15px rgba(255, 214, 10, 0.5);
        }
        
        .player-info {
            flex: 1;
        }
        
        .player-name {
            font-weight: bold;
            font-size: 16px;
            color: #fff;
            margin-bottom: 4px;
        }
        
        .game-details {
            font-size: 12px;
            color: rgba(255,255,255,0.7);
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .score-display {
            font-size: 24px;
            font-weight: bold;
            color: #4cc9f0;
            margin-left: 10px;
        }
        
        .loading-message, .no-records {
            text-align: center;
            color: rgba(255,255,255,0.6);
            padding: 40px 20px;
            font-style: italic;
        }
        
        .upload-status {
            background: rgba(0,0,0,0.5);
            padding: 10px 20px;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        
        .upload-status.success {
            background: rgba(76, 201, 240, 0.2);
            border: 1px solid #4cc9f0;
        }
        
        .upload-status.error {
            background: rgba(247, 37, 133, 0.2);
            border: 1px solid #f72585;
        }
        
        .close-button {
            background: linear-gradient(135deg, #4361ee, #3a0ca3);
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }
        
        .close-button:hover {
            background: linear-gradient(135deg, #4895ef, #3f37c9);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        html, body, div, span, h1, h2, h3, p, a, button, input, label,
        .game-container, .target, .head, .body, .home-screen, .start-screen,
        .end-screen, .instructions-screen, .info-panel, .settings-panel,
        .game-title, .subtitle, .game-menu, .game-info,
        .footer, .settings-toggle, .menu-button, .combo-display,
        .floating-text, .countdown {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-user-drag: none;
            -webkit-tap-highlight-color: transparent;
        }

        .color-options {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 5px;
        }
        
        .color-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid rgba(255,255,255,0.3);
            transition: all 0.2s ease;
        }
        
        .color-option:hover {
            transform: scale(1.1);
            border-color: rgba(255,255,255,0.8);
        }
        
        .color-option.active {
            border: 3px solid #fff;
            box-shadow: 0 0 10px rgba(255,255,255,0.5);
        }

        .color-custom {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
        }
        
        .color-input {
            width: 60px;
            height: 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            padding: 0;
            background: none;
        }
        
        .color-input::-webkit-color-swatch-wrapper {
            padding: 0;
        }
        
        .color-input::-webkit-color-swatch {
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 5px;
        }
        
        .color-apply {
            padding: 5px 10px;
            background: linear-gradient(135deg, #4361ee, #3a0ca3);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .color-apply:hover {
            background: linear-gradient(135deg, #4895ef, #3f37c9);
            transform: translateY(-2px);
        }

        /* 背景模式按鈕 */
        .bg-mode-buttons {
            display: flex;
            gap: 8px;
            margin-top: 5px;
        }
        
        .bg-mode-button {
            flex: 1;
            padding: 8px 5px;
            font-size: 14px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: rgba(255,255,255,0.6);
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .bg-mode-button.active {
            background: linear-gradient(135deg, #4895ef, #3f37c9);
            color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        
        .bg-mode-button:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .bg-mode-button.active:hover {
            background: linear-gradient(135deg, #5ba3f0, #4361ee);
            transform: translateY(-2px);
        }

        /* 背景圖片選項 */
        .bg-image-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        
        .bg-image-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            padding: 8px;
            transition: all 0.3s ease;
            background: rgba(255,255,255,0.1);
        }
        
        .bg-image-option:hover {
            border-color: rgba(255,255,255,0.5);
            transform: translateY(-2px);
        }
        
        .bg-image-option.active {
            border-color: #4895ef;
            background: rgba(72, 149, 239, 0.2);
            box-shadow: 0 0 10px rgba(72, 149, 239, 0.3);
        }
        
        .bg-image-preview {
            width: 60px;
            height: 40px;
            border-radius: 5px;
            border: 1px solid rgba(255,255,255,0.3);
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 5px;
        }
        
        .no-image-text {
            font-size: 10px;
            color: #666;
            text-align: center;
        }
        
        .bg-image-name {
            font-size: 12px;
            text-align: center;
            color: white;
        }

        /* 預設背景圖片樣式 */
        .tech-bg {
            background-image: linear-gradient(45deg, #0a0a0a 25%, #1a1a2e 25%, #1a1a2e 50%, #0a0a0a 50%, #0a0a0a 75%, #1a1a2e 75%);
            background-size: 20px 20px;
        }
        
        .space-bg {
            background: radial-gradient(circle at 20% 80%, #120458 0%, #000000 50%), radial-gradient(circle at 80% 20%, #000428 0%, #004e92 50%), radial-gradient(circle at 40% 40%, #000000 0%, #0f0f23 50%);
        }
        
        .abstract-bg {
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%), linear-gradient(135deg, transparent 40%, rgba(255,255,255,0.1) 50%, transparent 60%);
        }
        
        .military-bg {
            background: repeating-linear-gradient(45deg, #2d2d2d 0px, #2d2d2d 10px, #3d3d3d 10px, #3d3d3d 20px), linear-gradient(135deg, #1a1a1a, #2a2a2a);
        }

        /* 圖片上傳區域 */
        .bg-image-upload {
            margin-top: 15px;
            padding: 10px;
            border: 2px dashed rgba(255,255,255,0.3);
            border-radius: 8px;
            text-align: center;
        }
        
        .bg-upload-button {
            padding: 8px 15px;
            background: linear-gradient(135deg, #4361ee, #3a0ca3);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .bg-upload-button:hover {
            background: linear-gradient(135deg, #4895ef, #3f37c9);
            transform: translateY(-2px);
        }
        
        .uploaded-image-preview {
            max-width: 100%;
            max-height: 80px;
            border-radius: 5px;
            margin: 10px 0;
            border: 1px solid rgba(255,255,255,0.3);
        }
        
        .remove-image-button {
            padding: 5px 10px;
            background: linear-gradient(135deg, #e63946, #dc2626);
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
            transition: all 0.3s ease;
        }
        
        .remove-image-button:hover {
            background: linear-gradient(135deg, #f77f00, #e63946);
            transform: translateY(-1px);
        }

        /* 透明度控制 */
        .bg-image-opacity {
            margin-top: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .bg-image-opacity label {
            font-size: 14px;
            margin-bottom: 0;
            white-space: nowrap;
        }
        
        .bg-image-opacity input[type="range"] {
            flex: 1;
            height: 6px;
            background: rgba(255,255,255,0.2);
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
        }
        
        .bg-image-opacity input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: linear-gradient(135deg, #4895ef, #3f37c9);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        
        .bg-image-opacity input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: linear-gradient(135deg, #4895ef, #3f37c9);
            border-radius: 50%;
            border: none;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        
        #bg-opacity-value {
            font-size: 12px;
            color: #4895ef;
            font-weight: bold;
            min-width: 35px;
        }

        .pause-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 20;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        
        .pause-overlay h2 {
            font-size: 48px;
            margin-bottom: 30px;
            color: white;
            text-shadow: 0 0 15px rgba(76, 201, 240, 0.8);
        }
        
        .pause-controls {
            display: flex;
            gap: 20px;
        }
        
        #resume-button {
            background: linear-gradient(135deg, #4cc9f0, #4361ee);
        }
        
        #resume-button:hover {
            background: linear-gradient(135deg, #49d5ff, #536dff);
        }
        
        .color-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid rgba(255,255,255,0.3);
            transition: all 0.2s ease;
        }
        
        .color-option:hover {
            transform: scale(1.1);
            border-color: rgba(255,255,255,0.8);
        }
        
        .color-option.active {
            border: 3px solid #fff;
            box-shadow: 0 0 10px rgba(255,255,255,0.5);
        }

        @media screen and (max-width: 768px) {
            .home-screen {
                padding: 15px 15px;
                gap: 10px;
            }
            
            .game-title h1 {
                font-size: 36px;
                margin-bottom: 5px;
            }
            
            .subtitle {
                font-size: 16px;
            }
            
            .game-menu {
                width: 80%;
                max-width: 300px;
            }
            
            .game-info {
                width: 80%;
                max-width: 300px;
                padding: 10px;
            }
            
            .player-name-input {
                margin: 5px 0;
            }
            
            .player-name-input input {
                padding: 6px 10px;
                font-size: 13px;
            }
            
            .settings-panel {
                width: 90%;
                max-width: 300px;
            }
        }

        @media screen and (max-height: 600px) {
            .home-screen {
                padding: 10px 20px;
                gap: 8px;
            }
            
            .game-title h1 {
                font-size: 32px;
                margin-bottom: 3px;
            }
            
            .game-title {
                margin-bottom: 0px;
            }
            
            .game-menu {
                gap: 8px;
            }
            
            .menu-button {
                padding: 10px 15px;
                font-size: 16px;
            }
            
            .game-info {
                padding: 10px;
            }
            
            .footer {
                margin-top: 5px;
                font-size: 12px;
            }
        }
    </style>
    
    <!-- 結構化資料 JSON-LD -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "VideoGame",
        "name": "射擊挑戰",
        "description": "考驗精準度與反應速度的HTML5網頁射擊遊戲，支援全球排行榜、多種遊戲模式和難度設定。",
        "publisher": {
            "@type": "Organization",
            "name": "射擊挑戰遊戲開發團隊"
        },
        "genre": ["射擊遊戲", "休閒遊戲", "技能遊戲"],
        "gamePlatform": "Web Browser",
        "applicationCategory": "Game",
        "operatingSystem": "Any",
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "TWD",
            "availability": "https://schema.org/InStock"
        },
        "gameItem": [
            {
                "@type": "Thing",
                "name": "人形模式"
            },
            {
                "@type": "Thing", 
                "name": "靶心模式"
            },
            {
                "@type": "Thing",
                "name": "全球排行榜"
            }
        ]
    }
    </script>
</head>
<body>
    <div class="game-container" id="game-container">
        
        <div class="info-panel">
            <div class="time"><i class="fas fa-clock"></i>時間: <span id="time-left">60</span></div>
            <div class="controls">
                <button id="pause-game-button" class="small-button">暫停</button>
                <button id="end-game-button" class="small-button">結束遊戲</button>
            </div>
            <div class="score"><i class="fas fa-star"></i>分數: <span id="score">0</span></div>
        </div>

        <div class="combo-display" id="combo-display" style="display: none;">
            連擊: <span id="combo-count" class="combo-count">0</span>
        </div>

        <div class="target" id="target">
            <div class="head" id="head"></div>
            <div class="body"></div>
            <div class="arm-left"></div>
            <div class="arm-right"></div>
            <div class="leg-left"></div>
            <div class="leg-right"></div>
        </div>

        <div class="home-screen" id="home-screen">
            
            <button id="settings-button" class="settings-toggle">設定</button>

            
            <div class="game-title">
                <h1>射擊挑戰</h1>
                <div class="subtitle">精準瞄準，快速反應</div>
            </div>
            
            <div class="game-menu" role="navigation" aria-label="遊戲主選單">
                <button id="play-button" class="menu-button" aria-label="開始射擊挑戰遊戲">開始遊戲</button>
                <button id="home-toggle-mode" class="menu-button" aria-label="切換人形模式和靶心模式">切換模式</button>
                <button id="leaderboard-button" class="menu-button" aria-label="查看全球玩家排行榜">全球排行榜</button>
                <button id="instructions-button" class="menu-button" aria-label="查看遊戲玩法說明">遊戲說明</button>
            </div>
            
            <div class="game-info">
                <div class="player-name-input">
                    <label for="player-name">玩家名稱:</label>
                    <input type="text" id="player-name" placeholder="請輸入您的名稱" maxlength="20">
                </div>
                <div class="mode-display">
                    當前模式: <span id="current-mode">人形靶子</span>
                </div>
                <div class="move-display">
                    移動效果: <span id="current-move-type">漸變移動</span>
                </div>
                <div class="trigger-display">
                    觸發方式: <span id="current-move-trigger">手動移動</span>
                </div>
                <div class="high-score">
                    最高分數: <span id="high-score">0</span>
                </div>
            </div>
            
            <div class="footer">
                射擊挑戰遊戲 &copy; 2025
            </div>
        </div>

        <div class="start-screen" id="start-screen">
            <h1>射擊挑戰遊戲</h1>
            <p>射擊人形靶子的<strong>頭部</strong>獲得分數，<strong>沒射中會扣1分</strong>，一分鐘內看看你能獲得多少分！</p>
            <div class="button-group">
                <button id="start-button">開始遊戲</button>
                <button id="back-to-home">返回首頁</button>
            </div>
        </div>

        <div class="instructions-screen" id="instructions-screen">
            <h1>遊戲說明</h1>
            <div class="instructions-content">
                <h2>遊戲模式</h2>
                <p><strong>人形模式：</strong>射擊人形靶子的頭部才能得分，其他部位點擊無效。</p>
                <p><strong>靶心模式：</strong>射擊圓形靶心的任何部位都可得分。</p>
                
                <h2>遊戲規則</h2>
                <ul>
                    <li>遊戲時間為60秒</li>
                    <li><strong>手動移動：</strong>射擊有效目標後，目標會隨機移動位置</li>
                    <li><strong>自動連續移動：</strong>靶子會定時自動移動，移動間隔根據難度調整（簡單：3-5秒，中等：2-4秒，困難：1-3秒）</li>
                    <li><strong>持續移動：</strong>靶子會以固定間隔持續移動，移動更加頻繁（簡單：2秒，中等：1.5秒，困難：1秒）</li>
                    <li>每次射擊成功得1分</li>
                    <li>沒射到靶子會扣1分</li>
                    <li>連續命中可獲得連擊加成</li>
                    <li>每10連擊可獲得額外獎勵分數1分</li>
                    <li>可以隨時結束遊戲或暫停遊戲</li>
                </ul>
                
                <h2>難度設定</h2>
                <ul>
                    <li><strong>簡單：</strong>目標移動速度慢，尺寸較大（自動移動間隔：3-5秒，持續移動間隔：2秒）</li>
                    <li><strong>中等：</strong>目標移動速度中等，標準尺寸（自動移動間隔：2-4秒，持續移動間隔：1.5秒）</li>
                    <li><strong>困難：</strong>目標移動速度快，尺寸較小（自動移動間隔：1-3秒，持續移動間隔：1秒）</li>
                </ul>
                
                <h2>遊戲設定</h2>
                <ul>
                    <li><strong>移動效果：</strong>可選擇漸變移動或瞬間移動</li>
                    <li><strong>移動觸發方式：</strong>可選擇手動移動（射擊命中後移動）、自動連續移動（定時自動移動）或持續移動（固定間隔持續移動）</li>
                    <li><strong>顏色設定：</strong>可自定義背景和標靶顏色</li>
                    <li><strong>音效設定：</strong>可調整音量或設為靜音</li>
                </ul>
                
                <h2>其他功能</h2>
                <ul>
                    <li><strong>暫停功能：</strong>遊戲中可隨時暫停</li>
                    <li><strong>最高分數：</strong>自動記錄最高分</li>
                    <li><strong>全球排行榜：</strong>與全世界玩家比拼分數</li>
                </ul>
            </div>
            <button id="back-from-instructions">返回首頁</button>
        </div>

        <div class="end-screen" id="end-screen">
            <h1>遊戲結束！</h1>
            <div class="score-display">你的分數: <span id="final-score">0</span></div>
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-name">最高連擊:</div>
                    <div class="stat-value" id="max-combo">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-name">命中率:</div>
                    <div class="stat-value" id="accuracy">0%</div>
                </div>
                <div class="stat-item">
                    <div class="stat-name">命中次數:</div>
                    <div class="stat-value" id="shots-hit">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-name">未命中次數:</div>
                    <div class="stat-value" id="shots-missed">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-name">獎勵分數:</div>
                    <div class="stat-value" id="bonus-points">0</div>
                </div>
            </div>
            <div class="button-group">
                <button id="restart-button">再玩一次</button>
                <button id="home-button">返回首頁</button>
            </div>
        </div>

        <div class="settings-panel" id="settings-panel">
            <h2>遊戲設定</h2>
            <div class="setting-item">
                <label for="volume-control">音量</label>
                <input type="range" id="volume-control" min="0" max="1" step="0.1" value="0.7">
            </div>
            <div class="setting-item">
                <label for="mute-toggle">靜音</label>
                <input type="checkbox" id="mute-toggle">
            </div>
            <div class="setting-item">
                <label>難度</label>
                <div class="difficulty-buttons">
                    <button id="easy-button" class="diff-button">簡單</button>
                    <button id="medium-button" class="diff-button active">中等</button>
                    <button id="hard-button" class="diff-button">困難</button>
                </div>
            </div>
            <div class="setting-item">
                <label>移動效果</label>
                <div class="move-type-buttons">
                    <button id="transition-move" class="move-button active">漸變移動</button>
                    <button id="instant-move" class="move-button">瞬間移動</button>
                </div>
            </div>
            <div class="setting-item">
                <label>移動觸發方式</label>
                <div class="move-trigger-buttons">
                    <button id="manual-move" class="move-button active">手動移動</button>
                    <button id="auto-move" class="move-button">自動連續</button>
                    <button id="continuous-move" class="move-button">持續移動</button>
                </div>
            </div>
            <div class="setting-item">
                <label>背景模式</label>
                <div class="bg-mode-buttons">
                    <button id="bg-mode-color" class="bg-mode-button active">顏色背景</button>
                    <button id="bg-mode-image" class="bg-mode-button">圖片背景</button>
                </div>
            </div>
            <div class="setting-item" id="bg-color-setting">
                <label>背景顏色</label>
                <div class="color-options" id="bg-color-options">
                    <div class="color-option" data-color="#16213e" style="background-color: #16213e;"></div>
                    <div class="color-option" data-color="#1a1a2e" style="background-color: #1a1a2e;"></div>
                    <div class="color-option" data-color="#3a0ca3" style="background-color: #3a0ca3;"></div>
                    <div class="color-option" data-color="#3d405b" style="background-color: #3d405b;"></div>
                    <div class="color-option" data-color="#3d0066" style="background-color: #3d0066;"></div>
                    <div class="color-option" data-color="#242423" style="background-color: #242423;"></div>
                    <div class="color-option" data-color="#1b4332" style="background-color: #1b4332;"></div>
                    <div class="color-option" data-color="#582f0e" style="background-color: #582f0e;"></div>
                    <div class="color-option" data-color="#023047" style="background-color: #023047;"></div>
                    <div class="color-option" data-color="#370617" style="background-color: #370617;"></div>
                    <div class="color-option" data-color="#000814" style="background-color: #000814;"></div>
                    <div class="color-option" data-color="#540b0e" style="background-color: #540b0e;"></div>
                </div>
                <div class="color-custom">
                    <input type="color" id="bg-color-custom" class="color-input" value="#16213e">
                    <button id="bg-color-apply" class="color-apply">套用</button>
                </div>
            </div>
            <div class="setting-item" id="bg-image-setting" style="display: none;">
                <label>背景圖片</label>
                <div class="bg-image-options" id="bg-image-options">
                    <div class="bg-image-option" data-image="none">
                        <div class="bg-image-preview" style="background: linear-gradient(45deg, #ccc 25%, transparent 25%), linear-gradient(-45deg, #ccc 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #ccc 75%), linear-gradient(-45deg, transparent 75%, #ccc 75%); background-size: 10px 10px; background-position: 0 0, 0 5px, 5px -5px, -5px 0px;">
                            <span class="no-image-text">無圖片</span>
                        </div>
                    </div>
                    <div class="bg-image-option" data-image="tech">
                        <div class="bg-image-preview tech-bg"></div>
                        <span class="bg-image-name">科技風格</span>
                    </div>
                    <div class="bg-image-option" data-image="space">
                        <div class="bg-image-preview space-bg"></div>
                        <span class="bg-image-name">太空場景</span>
                    </div>
                    <div class="bg-image-option" data-image="abstract">
                        <div class="bg-image-preview abstract-bg"></div>
                        <span class="bg-image-name">抽象圖案</span>
                    </div>
                    <div class="bg-image-option" data-image="military">
                        <div class="bg-image-preview military-bg"></div>
                        <span class="bg-image-name">軍事風格</span>
                    </div>
                </div>
                <div class="bg-image-upload">
                    <input type="file" id="bg-image-file" accept="image/*" style="display: none;">
                    <button id="bg-image-upload-btn" class="bg-upload-button">上傳自訂圖片</button>
                    <div id="bg-image-preview-container" style="display: none;">
                        <img id="bg-image-preview" class="uploaded-image-preview" alt="預覽圖片">
                        <button id="bg-image-remove" class="remove-image-button">移除</button>
                    </div>
                </div>
                <div class="bg-image-opacity">
                    <label for="bg-opacity-control">背景透明度</label>
                    <input type="range" id="bg-opacity-control" min="0.1" max="1" step="0.1" value="0.8">
                    <span id="bg-opacity-value">80%</span>
                </div>
            </div>
            <div class="setting-item">
                <label>標靶顏色</label>
                <div class="color-options" id="target-color-options">
                    <div class="color-option" data-color="#4d96ff" style="background-color: #4d96ff;"></div>
                    <div class="color-option" data-color="#f72585" style="background-color: #f72585;"></div>
                    <div class="color-option" data-color="#4cc9f0" style="background-color: #4cc9f0;"></div>
                    <div class="color-option" data-color="#f77f00" style="background-color: #f77f00;"></div>
                    <div class="color-option" data-color="#2ec4b6" style="background-color: #2ec4b6;"></div>
                    <div class="color-option" data-color="#fb5607" style="background-color: #fb5607;"></div>
                    <div class="color-option" data-color="#70e000" style="background-color: #70e000;"></div>
                    <div class="color-option" data-color="#ff9f1c" style="background-color: #ff9f1c;"></div>
                    <div class="color-option" data-color="#e63946" style="background-color: #e63946;"></div>
                    <div class="color-option" data-color="#588157" style="background-color: #588157;"></div>
                    <div class="color-option" data-color="#06d6a0" style="background-color: #06d6a0;"></div>
                    <div class="color-option" data-color="#ff85a1" style="background-color: #ff85a1;"></div>
                </div>
                <div class="color-custom">
                    <input type="color" id="target-color-custom" class="color-input" value="#4d96ff">
                    <button id="target-color-apply" class="color-apply">套用</button>
                </div>
            </div>
            <button id="close-settings">關閉</button>
        </div>


        <div class="pause-overlay" id="pause-overlay">
            <h2>遊戲暫停</h2>
            <div class="pause-controls">
                <button id="resume-button">繼續遊戲</button>
                <button id="pause-end-game">結束遊戲</button>
            </div>
        </div>

        <div class="leaderboard-screen" id="leaderboard-screen">
            <h1>🏆 全球排行榜</h1>
            
            <div class="leaderboard-filters">
                <button id="filter-all" class="filter-button active">全部</button>
                <button id="filter-human" class="filter-button">人形模式</button>
                <button id="filter-circle" class="filter-button">靶心模式</button>
                <button id="filter-today" class="filter-button">今日</button>
            </div>
            
            <div class="leaderboard-content" id="leaderboard-content">
                <div class="loading-message">載入中...</div>
            </div>
            
            <div class="upload-status" id="upload-status" style="display: none;">
                <span id="upload-message"></span>
            </div>
            
            <button id="close-leaderboard" class="close-button">返回首頁</button>
        </div>

        <audio id="sound-shot" src="sounds/shot.mp3" preload="auto"></audio>
        <audio id="sound-hit" src="sounds/hit.mp3" preload="auto"></audio>
        <audio id="sound-miss" src="sounds/miss.mp3" preload="auto"></audio>
        <audio id="sound-game-start" src="sounds/game-start.mp3" preload="auto"></audio>
        <audio id="sound-game-end" src="sounds/game-end.mp3" preload="auto"></audio>
        <audio id="sound-bgm" src="sounds/background-music.mp3" preload="auto" loop></audio>
        
    </div>
    
    <script>
        // Firebase 配置
        const firebaseConfig = {
            apiKey: "AIzaSyB8K49Pme6uCR3WKMjbmXXT8YDbJTJdkoc",
            authDomain: "shooting-game-leaderboard.firebaseapp.com",
            projectId: "shooting-game-leaderboard",
            storageBucket: "shooting-game-leaderboard.firebasestorage.app",
            messagingSenderId: "454346518154",
            appId: "1:454346518154:web:b0610b87774425f57cc773",
            measurementId: "G-RDZDLCPZCL"
        };

        // 初始化 Firebase
        let db = null;
        let isFirebaseEnabled = false;
        
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            isFirebaseEnabled = true;
            console.log('Firebase 初始化成功');
            console.log('排行榜功能已啟用');
        } catch (error) {
            console.error('Firebase 初始化失敗:', error);
            console.log('排行榜功能暫時無法使用');
        }

        const homeScreen = document.getElementById('home-screen');
        const startScreen = document.getElementById('start-screen');
        const endScreen = document.getElementById('end-screen');
        const instructionsScreen = document.getElementById('instructions-screen');
        const timeLeftDisplay = document.getElementById('time-left');
        const scoreDisplay = document.getElementById('score');
        const finalScoreDisplay = document.getElementById('final-score');
        const currentModeDisplay = document.getElementById('current-mode');
        const highScoreDisplay = document.getElementById('high-score');
        const startButton = document.getElementById('start-button');
        const playButton = document.getElementById('play-button');
        const restartButton = document.getElementById('restart-button');
        const homeButton = document.getElementById('home-button');
        const backToHomeButton = document.getElementById('back-to-home');
        const instructionsButton = document.getElementById('instructions-button');
        const backFromInstructionsButton = document.getElementById('back-from-instructions');
        const homeToggleModeButton = document.getElementById('home-toggle-mode');
        const gameContainer = document.getElementById('game-container');
        const comboDisplay = document.getElementById('combo-display');
        const comboCountDisplay = document.getElementById('combo-count');
        const maxComboDisplay = document.getElementById('max-combo');
        const accuracyDisplay = document.getElementById('accuracy');
        const bonusPointsDisplay = document.getElementById('bonus-points');
        const crosshair = document.getElementById('crosshair');
        
        // 排行榜相關元素
        const leaderboardScreen = document.getElementById('leaderboard-screen');
        const leaderboardButton = document.getElementById('leaderboard-button');
        const closeLeaderboardButton = document.getElementById('close-leaderboard');
        const leaderboardContent = document.getElementById('leaderboard-content');
        const uploadStatus = document.getElementById('upload-status');
        const uploadMessage = document.getElementById('upload-message');
        const playerNameInput = document.getElementById('player-name');

        function getTarget() {
            return document.getElementById('target');
        }

        const sounds = {};

        let score = 0;
        let timeLeft = 60;
        let gameInterval;
        let isPlaying = false;
        let isPaused = false; 
        let gameMode = "human"; // "human", "target"
        let highScore = 0; 
        let combo = 0; 
        let maxCombo = 0; 
        let shotsFired = 0; 
        let shotsHit = 0; 
        let bonusPoints = 0; 
        let lastHitTime = 0; 
        let moveType = "transition";
        let moveTrigger = "manual"; // "manual" 手動移動, "auto" 自動連續移動, "continuous" 持續移動
        let movingInterval = null; // 自動移動計時器
        let continuousInterval = null; // 持續移動計時器 
 

        let bgColor = "#16213e"; 
        let targetColor = "#4d96ff";
        let bgMode = "color"; // "color" 或 "image"
        let bgImage = "none"; // 背景圖片類型或base64數據
        let bgOpacity = 0.8; // 背景透明度
        let customBgImage = null; // 自訂背景圖片數據 

        const difficulties = {
            easy: { targetSpeed: 1000, targetSize: 1.2 },
            medium: { targetSpeed: 700, targetSize: 1.0 },
            hard: { targetSpeed: 400, targetSize: 0.8 }
        };
        
        let currentDifficulty = 'medium'; 

        const soundSettings = {
            volume: 0.7,
            muted: false
        };

        function initSounds() {
            try {

                console.log('開始初始化音效...');

            sounds.shot = document.getElementById('sound-shot');
            sounds.hit = document.getElementById('sound-hit');
            sounds.miss = document.getElementById('sound-miss');
            sounds.gameStart = document.getElementById('sound-game-start');
            sounds.gameEnd = document.getElementById('sound-game-end');
            sounds.bgm = document.getElementById('sound-bgm');

                Object.entries(sounds).forEach(([key, sound]) => {
                    if (!sound) {
                        console.error(`找不到音效元素 ${key}`);
                    } else {
                        console.log(`音效 ${key} 初始化成功, 路徑: ${sound.src}`);

                        sound.load();

                sound.volume = soundSettings.volume;

                        sound.onerror = function(e) {
                            console.error(`音效 ${key} 加載失敗:`, e);
                            console.error(`嘗試載入的路徑: ${sound.src}`);
                        };

                        sound.onloadeddata = function() {
                            console.log(`音效 ${key} 加載成功`);
                        };
                    }
                });

                try {
                    const silentSound = new Audio("data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4Ljc2LjEwMAAAAAAAAAAAAAAA//tQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAASAAAeMwAUFBQUFCIiIiIiIjAwMDAwPj4+Pj4+TExMTExZWVlZWVlnZ2dnZ3V1dXV1dYODg4ODkZGRkZGRn5+fn5+frKysrKy6urq6urqIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIgAP/7UMQAABTBMi8PQZC8DpJ3h+DghVYGnP3N1dfWAAMDAyMECBAgAAGBgZGBAgQIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//sQxCmAEhGNJ+gigGG2jab7IGaAAAAACQQghnhBBBCQQjgAAQQQSCCEEIIT//wQgghnhBBBCQQjgAAQQQSCCEEIIT//wQgghnhBBBCQQjgAAQQQSCCEEIIT//wQgghnhBBBCQQjgAAQQQSCCEEIIT//wQgghnhBBBCQQjgAAQQQSCCEEIIT//wQgghnhBBBCQQjg");
                    silentSound.volume = 0;
                    silentSound.play().catch(e => {
                        console.warn('無法播放靜音音頻:', e);
                    });
                } catch (e) {
                    console.warn('嘗試播放靜音音頻時出錯:', e);
                }
                
                console.log('音效初始化完成');
            } catch (e) {
                console.error('初始化音效時發生錯誤:', e);
            }
        }

        function playSound(soundName) {

            if (soundSettings.muted) {
                console.log(`音效 ${soundName} 被靜音`);
                return;
            }

            if (!sounds[soundName]) {
                console.error(`音效 ${soundName} 不存在`);

                const audioElement = document.getElementById(`sound-${soundName}`);
                if (audioElement) {
                    console.log(`嘗試重新獲取音效元素 ${soundName}`);
                    sounds[soundName] = audioElement;
                } else {
                    console.error(`找不到音效元素 sound-${soundName}`);
                    return;
                }
            }

            if (sounds[soundName].readyState === 0) {
                console.warn(`音效 ${soundName} 尚未加載完成，嘗試重新載入`);
                sounds[soundName].load();
            }

            try {
            sounds[soundName].currentTime = 0;
            sounds[soundName].volume = soundSettings.volume;

                const playPromise = sounds[soundName].play();

                if (playPromise !== undefined) {
                    playPromise
                        .then(() => {
                            console.log(`音效 ${soundName} 播放成功`);
                        })
                        .catch(e => {
                            console.error(`播放音效 ${soundName} 失敗:`, e);

                            if (e.name === 'NotAllowedError') {
                                console.warn('播放音效需要用戶交互，將在下一次用戶交互時嘗試播放');

                                const playOnClick = () => {
                                    sounds[soundName].play()
                                        .then(() => {
                                            document.removeEventListener('click', playOnClick);
                                        })
                                        .catch(innerError => {
                                            console.error('再次嘗試播放失敗:', innerError);
                                        });
                                };
                                document.addEventListener('click', playOnClick);
                            }
                        });
                }
            } catch (e) {
                console.error(`嘗試播放音效 ${soundName} 時發生錯誤:`, e);
            }
        }

        function testSound(soundName) {
            const resultElement = document.getElementById('sound-test-result');
            resultElement.innerHTML = `嘗試播放 ${soundName} 音效...`;
            
            try {
                const audioElement = document.getElementById(`sound-${soundName}`);
                if (!audioElement) {
                    resultElement.innerHTML += '<br>找不到音效元素！請檢查HTML中的audio標籤。';
                    return;
                }
                
                resultElement.innerHTML += `<br>音效元素找到: ${audioElement.id}`;
                resultElement.innerHTML += `<br>音效檔案路徑: ${audioElement.src}`;

                const tempAudio = new Audio();
                tempAudio.onloadeddata = function() {
                    resultElement.innerHTML += '<br>音效檔案載入成功！';
                    resultElement.innerHTML += '<br>嘗試播放...';

                    tempAudio.play()
                        .then(() => {
                            resultElement.innerHTML += '<br><span style="color: #4cc9f0;">播放成功！</span>';
                        })
                        .catch(e => {
                            resultElement.innerHTML += `<br><span style="color: #f72585;">播放失敗: ${e.message}</span>`;
                            resultElement.innerHTML += '<br>可能原因: 瀏覽器阻止自動播放、檔案損壞或格式不支援';
                        });
                };
                
                tempAudio.onerror = function() {
                    resultElement.innerHTML += `<br><span style="color: #f72585;">音效檔案載入失敗！</span>`;
                    resultElement.innerHTML += '<br>可能原因: 檔案路徑錯誤、檔案不存在或格式不支援';
                    resultElement.innerHTML += `<br>請檢查 ${audioElement.src} 是否存在且可訪問`;
                };
                
                tempAudio.src = audioElement.src;
            } catch (e) {
                resultElement.innerHTML += `<br><span style="color: #f72585;">錯誤: ${e.message}</span>`;
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const openButton = document.getElementById('open-sound-test');
            const closeButton = document.getElementById('close-sound-test');
            const testShotButton = document.getElementById('test-shot-sound');
            const testHitButton = document.getElementById('test-hit-sound');
            const testMissButton = document.getElementById('test-miss-sound');
            const testPanel = document.getElementById('sound-test-panel');
            
            if (openButton) {
                openButton.addEventListener('click', function() {
                    testPanel.style.display = 'block';
                });
            }
            
            if (closeButton) {
                closeButton.addEventListener('click', function() {
                    testPanel.style.display = 'none';
                });
            }
            
            if (testShotButton) {
                testShotButton.addEventListener('click', function() {
                    testSound('shot');
                });
            }
            
            if (testHitButton) {
                testHitButton.addEventListener('click', function() {
                    testSound('hit');
                });
            }
            
            if (testMissButton) {
                testMissButton.addEventListener('click', function() {
                    testSound('miss');
                });
            }
        });

        function initGame() {
            score = 0;
            timeLeft = 60;
            combo = 0;
            maxCombo = 0;
            shotsFired = 0;
            shotsHit = 0;
            bonusPoints = 0;
            
            scoreDisplay.textContent = score;
            timeLeftDisplay.textContent = timeLeft;
            comboCountDisplay.textContent = combo;
            comboDisplay.style.display = 'none';
            
            getTarget().style.display = 'none';
            isPlaying = false;
            clearInterval(gameInterval);

            highScoreDisplay.textContent = highScore;

            setupTargetByMode();

            currentModeDisplay.textContent = gameMode === "human" ? "人形靶子" : gameMode === "target" ? "靶心" : "人形靶子";

            document.getElementById('current-move-type').textContent = moveType === 'transition' ? '漸變移動' : '瞬間移動';
            let moveTriggerText = '手動移動';
            if (moveTrigger === 'auto') {
                moveTriggerText = '自動連續';
            } else if (moveTrigger === 'continuous') {
                moveTriggerText = '持續移動';
            }
            document.getElementById('current-move-trigger').textContent = moveTriggerText;

            document.querySelectorAll('.bullet-hole, .particle, .floating-text').forEach(el => {
                el.remove();
            });

            timeLeftDisplay.classList.remove('time-warning');

            gameContainer.style.cursor = 'crosshair';

            setBgColor(bgColor);
            setTargetColor(targetColor);
        }

        function showHome() {
            homeScreen.style.display = 'flex';
            startScreen.style.display = 'none';
            endScreen.style.display = 'none';
            instructionsScreen.style.display = 'none';
            getTarget().style.display = 'none';

            homeScreen.classList.add('fade-in');
            
            isPlaying = false;
            clearInterval(gameInterval);

            if (sounds.bgm) {
                sounds.bgm.pause();
                sounds.bgm.currentTime = 0;
            }

            highScoreDisplay.textContent = highScore;
            updateModeUI();
        }

        function showStartScreen() {
            homeScreen.style.display = 'none';
            startScreen.style.display = 'flex';
            endScreen.style.display = 'none';
            instructionsScreen.style.display = 'none';
            getTarget().style.display = 'none';

            document.getElementById('settings-panel').classList.remove('show-settings');

            startScreen.classList.add('slide-in');
        }

        function showInstructions() {
            homeScreen.style.display = 'none';
            startScreen.style.display = 'none';
            endScreen.style.display = 'none';
            instructionsScreen.style.display = 'flex';
            getTarget().style.display = 'none';

            document.getElementById('settings-panel').classList.remove('show-settings');

            instructionsScreen.classList.add('fade-in');
        }

        function updateModeUI() {
            // 更新按鈕文字
            const nextMode = gameMode === "human" ? "靶心模式" : "人形模式";
            
            const toggleModeButton = document.getElementById('toggle-mode-button');
            if (toggleModeButton) {
                toggleModeButton.textContent = `切換至${nextMode}`;
            }
            
            homeToggleModeButton.textContent = `切換至${nextMode}`;

            // 更新當前模式顯示
            const modeText = gameMode === "human" ? "人形靶子" : "靶心";
            currentModeDisplay.textContent = modeText;
        }

        function setupTargetByMode() {

            const targetElement = getTarget();

            targetElement.innerHTML = '';
            
            if (gameMode === "human") {

                targetElement.classList.remove('circle-target');
                targetElement.innerHTML = `
                    <div class="head" id="head"></div>
                    <div class="body"></div>
                    <div class="arm-left"></div>
                    <div class="arm-right"></div>
                    <div class="leg-left"></div>
                    <div class="leg-right"></div>
                `;

                let gameDescription = '射擊人形靶子的<strong>頭部</strong>獲得分數，一分鐘內看看你能獲得多少分！';
                if (moveTrigger === "auto") {
                    const interval = getMovingModeIntervalRange();
                    gameDescription = `射擊人形靶子的<strong>頭部</strong>獲得分數，靶子會自動移動(${interval})！一分鐘內看看你能獲得多少分！`;
                } else if (moveTrigger === "continuous") {
                    const interval = getContinuousModeIntervalRange();
                    gameDescription = `射擊人形靶子的<strong>頭部</strong>獲得分數，靶子會持續移動(每${interval})！一分鐘內看看你能獲得多少分！`;
                }
                document.querySelector("#start-screen p").innerHTML = gameDescription;

                setTimeout(() => {
                    const head = document.getElementById('head');
                    if (head) {

                        head.removeEventListener('mousedown', handleHeadClick);
                        head.removeEventListener('touchstart', handleHeadTouchStart);

                        head.setAttribute('draggable', 'false');

                        head.addEventListener('mousedown', handleHeadClick);

                        head.addEventListener('touchstart', handleHeadTouchStart);
                    }

                    document.querySelectorAll('.head, .body, .arm-left, .arm-right, .leg-left, .leg-right').forEach(el => {
                        el.style.backgroundColor = targetColor;
                    });
                }, 0);

                targetElement.addEventListener('mousedown', function(e) {
                    if (!isPlaying || isPaused || e.target.id === 'head') return;

                    e.preventDefault();

                    shotsFired++;

                    playSound('miss');

                    createBulletHole(e.clientX, e.clientY);

                    this.classList.add('missed');
                    setTimeout(() => {
                        this.classList.remove('missed');
                    }, 200);

                    resetCombo();

                    if (score > 0) {
                        score--;
                        scoreDisplay.textContent = score;
                        showFloatingText('-1分', e.clientX, e.clientY, 'penalty-text');
                    }
                });

                targetElement.addEventListener('touchstart', function(e) {
                    if (!isPlaying || isPaused || e.target.id === 'head') return;

                    e.preventDefault();
                    
                    const touch = e.touches[0];

                    shotsFired++;

                    playSound('miss');

                    createBulletHole(touch.clientX, touch.clientY);

                    this.classList.add('missed');
                    setTimeout(() => {
                        this.classList.remove('missed');
                    }, 200);

                    resetCombo();

                    if (score > 0) {
                        score--;
                        scoreDisplay.textContent = score;
                        showFloatingText('-1分', touch.clientX, touch.clientY, 'penalty-text');
                    }
                });
            } else {

                const oldTarget = targetElement;
                const newTarget = oldTarget.cloneNode(false);
                oldTarget.parentNode.replaceChild(newTarget, oldTarget);

                newTarget.classList.add('circle-target');

                newTarget.setAttribute('draggable', 'false');

                let circleGameDescription = '點擊靶心獲得分數，一分鐘內看看你能獲得多少分！';
                if (moveTrigger === "auto") {
                    const interval = getMovingModeIntervalRange();
                    circleGameDescription = `點擊靶心獲得分數，靶子會自動移動(${interval})！一分鐘內看看你能獲得多少分！`;
                } else if (moveTrigger === "continuous") {
                    const interval = getContinuousModeIntervalRange();
                    circleGameDescription = `點擊靶心獲得分數，靶子會持續移動(每${interval})！一分鐘內看看你能獲得多少分！`;
                }
                document.querySelector("#start-screen p").innerHTML = circleGameDescription;

                newTarget.style.background = `radial-gradient(circle, white 10%, ${targetColor} 10%, ${targetColor} 30%, white 30%, white 50%, ${adjustColor(targetColor, -20)} 50%, ${adjustColor(targetColor, -20)} 70%, white 70%)`;

                newTarget.addEventListener('mousedown', handleTargetClick);

                newTarget.addEventListener('touchstart', handleTargetTouchStart);
            }

            setDifficulty(currentDifficulty);
        }

        function setDifficulty(level) {
            currentDifficulty = level;

            const scale = difficulties[level].targetSize;
            const targetElement = getTarget();
            if (targetElement) {
                targetElement.style.transform = `scale(${scale})`;
            }
        }

        function updateDifficultyButtons(activeDifficulty) {
            document.querySelectorAll('.diff-button').forEach(button => {
                button.classList.remove('active');
            });
            document.getElementById(`${activeDifficulty}-button`).classList.add('active');
        }

        function toggleGameMode() {

            if (isPlaying) {
                endGame();

                setTimeout(() => {
                    // 兩種模式循環切換: human -> target -> human
                    if (gameMode === "human") {
                        gameMode = "target";
                    } else {
                        gameMode = "human";
                    }

                    updateModeUI();
                    setupTargetByMode();

                    showStartScreen();
                }, 300); 
                
                return;
            }

            // 兩種模式循環切換
            if (gameMode === "human") {
                gameMode = "target";
            } else {
                gameMode = "human";
            }

            updateModeUI();
            setupTargetByMode();

            if (homeScreen.style.display === 'flex') {

                showHome();
            } else {

                showStartScreen();
            }
        }

        function showCountdown(callback) {
            const countdown = document.createElement('div');
            countdown.classList.add('countdown');
            gameContainer.appendChild(countdown);
            
            let count = 3;
            countdown.textContent = count;
            
            const interval = setInterval(() => {
                count--;
                if (count > 0) {
                    countdown.textContent = count;
                    countdown.classList.add('countdown-pulse');

                    playSound('gameStart');
                    setTimeout(() => {
                        countdown.classList.remove('countdown-pulse');
                    }, 900);
                } else {
                    clearInterval(interval);
                    countdown.textContent = '開始！';
                    setTimeout(() => {
                        countdown.remove();
                        if (callback) callback();
                    }, 1000);
                }
            }, 1000);
        }

        function startGame() {
            if (isPlaying) return;

            document.getElementById('settings-panel').classList.remove('show-settings');
            
            initGame();
            homeScreen.style.display = 'none';
            startScreen.style.display = 'none';
            endScreen.style.display = 'none';
            instructionsScreen.style.display = 'none';

            showCountdown(() => {
                getTarget().style.display = 'block';
                isPlaying = true;

                playSound('gameStart');

                playSound('bgm');

                placeTargetRandomly();

                // 根據移動觸發方式啟動對應的移動模式
                if (moveTrigger === 'auto') {
                    startAutoMovement();
                } else if (moveTrigger === 'continuous') {
                    startContinuousMovement();
                }

                gameInterval = setInterval(() => {
                    timeLeft--;
                    timeLeftDisplay.textContent = timeLeft;

                    if (timeLeft <= 10) {
                        timeLeftDisplay.classList.add('time-warning');
                    }
                    
                    if (timeLeft <= 0) {
                        endGame();
                    }
                }, 1000);
            });
        }

        function endGame() {
            isPlaying = false;
            isPaused = false; 
            clearInterval(gameInterval);
            stopContinuousMovement(); // 停止自動移動
            stopContinuousMovement(); // 停止持續移動
            getTarget().style.display = 'none';

            document.getElementById('pause-overlay').style.display = 'none';

            if (sounds.bgm) {
                sounds.bgm.pause();
                sounds.bgm.currentTime = 0;
            }

            playSound('gameEnd');

            comboDisplay.style.display = 'none';

            endScreen.classList.add('fade-in');
            endScreen.style.display = 'flex';

            finalScoreDisplay.textContent = score;
            maxComboDisplay.textContent = maxCombo;
            accuracyDisplay.textContent = shotsFired > 0 ? Math.round((shotsHit / shotsFired) * 100) + '%' : '0%';
            bonusPointsDisplay.textContent = bonusPoints;

            document.getElementById('shots-hit').textContent = shotsHit;
            document.getElementById('shots-missed').textContent = shotsFired - shotsHit;

            if (score > highScore) {
                highScore = score;
                highScoreDisplay.textContent = highScore;

                showNewRecord();
            }

            addGameRecord();
            
            // 上傳分數到排行榜
            uploadScoreToLeaderboard();

            timeLeftDisplay.classList.remove('time-warning');
        }

        function addGameRecord() {
            const newRecord = {
                date: new Date().toLocaleString(),
                score: score,
                mode: gameMode === "human" ? "人形靶子" : gameMode === "target" ? "靶心" : "持續移動靶子",
                moveType: moveType === "transition" ? "漸變移動" : "瞬間移動",
                accuracy: shotsFired > 0 ? Math.round((shotsHit / shotsFired) * 100) : 0
            };
        }

        // 排行榜功能
        async function uploadScoreToLeaderboard() {
            if (!isFirebaseEnabled) {
                console.log('Firebase 未啟用，跳過分數上傳');
                return;
            }

            const playerName = playerNameInput.value.trim();
            if (!playerName) {
                showUploadStatus('請輸入玩家名稱才能上傳分數', 'error');
                return;
            }

            if (playerName.length > 20) {
                showUploadStatus('玩家名稱不能超過20個字符', 'error');
                return;
            }

            // 防作弊檢查
            if (score > 1000) {
                console.warn('分數異常高，可能存在作弊行為');
            }

            const gameRecord = {
                playerName: playerName,
                score: score,
                gameMode: gameMode,
                difficulty: currentDifficulty,
                moveType: moveType,
                accuracy: shotsFired > 0 ? Math.round((shotsHit / shotsFired) * 100) : 0,
                maxCombo: maxCombo,
                shotsHit: shotsHit,
                shotsFired: shotsFired,
                bonusPoints: bonusPoints,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                playTime: 60 - timeLeft,
                ipHash: await getSimpleHash(getClientIP())
            };

            try {
                showUploadStatus('正在上傳分數...', 'info');
                
                await db.collection('leaderboard').add(gameRecord);
                
                showUploadStatus('分數上傳成功！', 'success');
                console.log('分數上傳成功');
                
                // 保存玩家名稱
                localStorage.setItem('shootingGamePlayerName', playerName);
                
            } catch (error) {
                console.error('分數上傳失敗:', error);
                showUploadStatus('分數上傳失敗，請檢查網路連線', 'error');
            }
        }

        function showUploadStatus(message, type) {
            uploadMessage.textContent = message;
            uploadStatus.className = `upload-status ${type}`;
            uploadStatus.style.display = 'block';
            
            setTimeout(() => {
                uploadStatus.style.display = 'none';
            }, 3000);
        }

        async function loadLeaderboard(filter = 'all') {
            if (!isFirebaseEnabled) {
                leaderboardContent.innerHTML = '<div class="no-records">排行榜功能需要 Firebase 配置</div>';
                return;
            }

            try {
                leaderboardContent.innerHTML = '<div class="loading-message">載入中...</div>';
                
                let query = db.collection('leaderboard');
                
                // 根據篩選條件調整查詢
                if (filter === 'human') {
                    query = query.where('gameMode', '==', 'human');
                } else if (filter === 'circle') {
                    query = query.where('gameMode', '==', 'target');
                } else if (filter === 'today') {
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    query = query.where('timestamp', '>=', today);
                }
                
                // 按分數降序排列，限制50條記錄
                query = query.orderBy('score', 'desc').limit(50);
                
                const snapshot = await query.get();
                const records = [];
                
                snapshot.forEach(doc => {
                    records.push({ id: doc.id, ...doc.data() });
                });
                
                displayLeaderboard(records);
                
            } catch (error) {
                console.error('載入排行榜失敗:', error);
                leaderboardContent.innerHTML = '<div class="no-records">載入排行榜失敗，請稍後再試</div>';
            }
        }

        function displayLeaderboard(records) {
            if (records.length === 0) {
                leaderboardContent.innerHTML = '<div class="no-records">暫無排行記錄</div>';
                return;
            }

            let html = '';
            records.forEach((record, index) => {
                const rank = index + 1;
                const isTopRank = rank <= 3;
                const date = record.timestamp ? record.timestamp.toDate().toLocaleDateString() : '未知';
                
                html += `
                    <div class="leaderboard-item">
                        <div class="rank-number ${isTopRank ? 'top-rank' : ''}">${rank}</div>
                        <div class="player-info">
                            <div class="player-name">${escapeHtml(record.playerName)}</div>
                            <div class="game-details">
                                <span>模式: ${record.gameMode === 'human' ? '人形' : record.gameMode === 'target' ? '靶心' : '持續移動'}</span>
                                <span>難度: ${getDifficultyText(record.difficulty)}</span>
                                <span>命中率: ${record.accuracy}%</span>
                                <span>日期: ${date}</span>
                            </div>
                        </div>
                        <div class="score-display">${record.score}</div>
                    </div>
                `;
            });
            
            leaderboardContent.innerHTML = html;
        }

        function getDifficultyText(difficulty) {
            const diffMap = { easy: '簡單', medium: '中等', hard: '困難' };
            return diffMap[difficulty] || difficulty;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // 簡單的IP獲取（用於防作弊）
        function getClientIP() {
            // 簡化版本，實際使用中可以使用第三方服務
            return 'unknown';
        }

        // 簡單的雜湊函數
        async function getSimpleHash(str) {
            const encoder = new TextEncoder();
            const data = encoder.encode(str + new Date().toDateString());
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('').substring(0, 8);
        }

        // 載入玩家名稱
        function loadPlayerName() {
            try {
                const savedName = localStorage.getItem('shootingGamePlayerName');
                if (savedName) {
                    playerNameInput.value = savedName;
                }
            } catch (error) {
                console.error('載入玩家名稱失敗:', error);
            }
        }




        function pauseGame() {
            if (!isPlaying || isPaused) return;
            
            isPaused = true;
            clearInterval(gameInterval);
            stopContinuousMovement(); // 暫停時停止自動移動
            stopContinuousMovement(); // 暫停時停止持續移動

            document.getElementById('pause-overlay').style.display = 'flex';

            document.getElementById('pause-game-button').textContent = '繼續';
        }

        function resumeGame() {
            if (!isPlaying || !isPaused) return;
            
            isPaused = false;

            document.getElementById('pause-overlay').style.display = 'none';

            document.getElementById('pause-game-button').textContent = '暫停';

            // 根據移動觸發方式恢復對應的移動模式
            if (moveTrigger === 'auto') {
                startAutoMovement();
            } else if (moveTrigger === 'continuous') {
                startContinuousMovement();
            }

            gameInterval = setInterval(() => {
                timeLeft--;
                timeLeftDisplay.textContent = timeLeft;

                if (timeLeft <= 10) {
                    timeLeftDisplay.classList.add('time-warning');
                }
                
                if (timeLeft <= 0) {
                    endGame();
                }
            }, 1000);
        }





        function setBgColor(color) {
            bgColor = color;
            if (bgMode === 'color') {
                applyBackground();
            }
            saveColorSettings();
        }





        function handleHeadClick(e) {
            if (!isPlaying || isPaused) return; 

            e.preventDefault();

            e.stopPropagation();

            shotsFired++;
            shotsHit++;

            score++;
            scoreDisplay.textContent = score;

            playSound('hit');

            createBulletHole(e.clientX, e.clientY);

            createHitEffect(this);

            createParticles(e.clientX, e.clientY, '#4cc9f0');

            updateCombo();

            screenShake(false);

            // 只有在手動移動模式下才射擊後移動靶子
            if (moveTrigger === 'manual') {
                placeTargetRandomly();
            }
        }

        function handleHeadTouchStart(e) {
            if (!isPlaying) return;

            e.preventDefault();

            e.stopPropagation();

            const touch = e.touches[0];

            shotsFired++;
            shotsHit++;

            score++;
            scoreDisplay.textContent = score;

            playSound('hit');

            createBulletHole(touch.clientX, touch.clientY);

            createHitEffect(this);

            createParticles(touch.clientX, touch.clientY, '#4cc9f0');

            updateCombo();

            screenShake(false);

            // 只有在手動移動模式下才射擊後移動靶子
            if (moveTrigger === 'manual') {
                placeTargetRandomly();
            }
        }

        function handleTargetClick(e) {
            if (!isPlaying || isPaused) return; 

            e.preventDefault();

            shotsFired++;
            shotsHit++;

            score++;
            scoreDisplay.textContent = score;

            playSound('hit');

            createBulletHole(e.clientX, e.clientY);

            createHitEffect(this);

            createParticles(e.clientX, e.clientY, '#4cc9f0');

            updateCombo();

            screenShake(false);

            // 只有在手動移動模式下才射擊後移動靶子
            if (moveTrigger === 'manual') {
                placeTargetRandomly();
            }
        }

        function handleTargetTouchStart(e) {
            if (!isPlaying) return;

            e.preventDefault();

            const touch = e.touches[0];

            shotsFired++;
            shotsHit++;

            score++;
            scoreDisplay.textContent = score;

            playSound('hit');

            createBulletHole(touch.clientX, touch.clientY);

            createHitEffect(this);

            createParticles(touch.clientX, touch.clientY, '#4cc9f0');

            updateCombo();

            screenShake(false);

            // 只有在手動移動模式下才射擊後移動靶子
            if (moveTrigger === 'manual') {
                placeTargetRandomly();
            }
        }

        gameContainer.addEventListener('mousedown', function(e) {
            if (!isPlaying || isPaused) return; 

            e.preventDefault();

            if (e.target.closest('.target') || 
                e.target.closest('.info-panel') || 
                e.target.closest('.settings-panel') ||
                e.target.closest('.settings-toggle') ||
                e.target.closest('.pause-overlay') ||
                e.target.closest('.combo-display')) return;

            shotsFired++;

            playSound('miss');

            createBulletHole(e.clientX, e.clientY);

            screenShake(true);

            resetCombo();

            if (score > 0) {
                score--;
                scoreDisplay.textContent = score;
                showFloatingText('-1分', e.clientX, e.clientY, 'penalty-text');
            }
        });

        gameContainer.addEventListener('touchstart', function(e) {
            if (!isPlaying || isPaused) return; 

            if (e.target.closest('.target') || 
                e.target.closest('.info-panel') || 
                e.target.closest('.settings-panel') ||
                e.target.closest('.settings-toggle') ||
                e.target.closest('.pause-overlay') ||
                e.target.closest('.combo-display')) return;

            e.preventDefault();

            const touch = e.touches[0];

            shotsFired++;

            playSound('miss');

            createBulletHole(touch.clientX, touch.clientY);

            screenShake(true);

            resetCombo();

            if (score > 0) {
                score--;
                scoreDisplay.textContent = score;
                showFloatingText('-1分', touch.clientX, touch.clientY, 'penalty-text');
            }
        });

        function updateCombo() {
            const now = Date.now();

            if (now - lastHitTime < 1500) {
                combo++;
            } else {
                combo = 1;
            }
            
            lastHitTime = now;

            if (combo > maxCombo) {
                maxCombo = combo;
            }

            comboDisplay.style.display = 'flex';
            comboCountDisplay.textContent = combo;

            if (combo >= 10 && combo % 10 === 0) {
                score++;
                bonusPoints++;
                scoreDisplay.textContent = score;
                showBonusText();
            }

            if (combo > 1) {
                showComboText();
            }
        }

        function resetCombo() {
            combo = 0;
            comboCountDisplay.textContent = combo;
            comboDisplay.style.display = 'none';
        }

        function showComboText() {
            const target = getTarget();
            const rect = target.getBoundingClientRect();
            const x = rect.left + rect.width / 2;
            const y = rect.top;
            showFloatingText(`${combo}連擊！`, x, y, 'combo-text');
        }

        function showBonusText() {
            const target = getTarget();
            const rect = target.getBoundingClientRect();
            const x = rect.left + rect.width / 2;
            const y = rect.top - 30;
            showFloatingText('+1分獎勵！', x, y, 'bonus-text');
        }

        function showNewRecord() {
            const newRecord = document.createElement('div');
            newRecord.classList.add('new-record');
            newRecord.textContent = '新紀錄！';
            endScreen.appendChild(newRecord);
            
            setTimeout(() => {
                newRecord.remove();
            }, 3000);
        }

        function showFloatingText(text, x, y, className) {
            const floatingText = document.createElement('div');
            floatingText.classList.add('floating-text', className);
            floatingText.textContent = text;

            const rect = gameContainer.getBoundingClientRect();

            const relativeX = x - rect.left;
            const relativeY = y - rect.top;
            
            floatingText.style.left = `${relativeX}px`;
            floatingText.style.top = `${relativeY}px`;
            gameContainer.appendChild(floatingText);
            
            setTimeout(() => {
                floatingText.remove();
            }, 1000);
        }

        function createBulletHole(x, y) {
            const bulletHole = document.createElement('div');
            bulletHole.classList.add('bullet-hole');

            const rect = gameContainer.getBoundingClientRect();

            const relativeX = x - rect.left;
            const relativeY = y - rect.top;
            
            bulletHole.style.left = `${relativeX}px`;
            bulletHole.style.top = `${relativeY}px`;
            gameContainer.appendChild(bulletHole);

            playSound('shot');

            setTimeout(() => {
                bulletHole.remove();
            }, 3000);
        }

        function createHitEffect(element) {
            element.classList.add('hit-flash');
            setTimeout(() => {
                element.classList.remove('hit-flash');
            }, 200);
        }

        function createParticles(x, y, color) {
            const particleCount = 10;

            const rect = gameContainer.getBoundingClientRect();

            const relativeX = x - rect.left;
            const relativeY = y - rect.top;
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.classList.add('particle');

                const size = Math.random() * 5 + 3;
                particle.style.width = `${size}px`;
                particle.style.height = `${size}px`;

                particle.style.backgroundColor = color;

                particle.style.left = `${relativeX}px`;
                particle.style.top = `${relativeY}px`;

                gameContainer.appendChild(particle);

                const angle = Math.random() * Math.PI * 2;
                const speed = Math.random() * 3 + 2;
                const vx = Math.cos(angle) * speed;
                const vy = Math.sin(angle) * speed;

                let posX = relativeX;
                let posY = relativeY;
                
                const animate = () => {

                    posX += vx;
                    posY += vy;

                    particle.style.left = `${posX}px`;
                    particle.style.top = `${posY}px`;

                    particle.style.opacity = parseFloat(particle.style.opacity || 1) - 0.02;
                    
                    if (parseFloat(particle.style.opacity) > 0) {
                        requestAnimationFrame(animate);
                    } else {
                        particle.remove();
                    }
                };
                
                requestAnimationFrame(animate);
            }
        }

        function screenShake(isLight) {
            if (isLight) {
                gameContainer.classList.add('screen-shake-light');
                setTimeout(() => {
                    gameContainer.classList.remove('screen-shake-light');
                }, 200);
            } else {
                gameContainer.classList.add('screen-shake');
                setTimeout(() => {
                    gameContainer.classList.remove('screen-shake');
                }, 300);
            }
        }


        function setActiveFilter(activeId) {
            document.querySelectorAll('.filter-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(activeId).classList.add('active');
        }


        // 背景圖片相關函數
        function setupBgModeButtons() {
            const colorModeButton = document.getElementById('bg-mode-color');
            const imageModeButton = document.getElementById('bg-mode-image');
            const colorSetting = document.getElementById('bg-color-setting');
            const imageSetting = document.getElementById('bg-image-setting');

            colorModeButton.addEventListener('click', function() {
                setBgMode('color');
                updateBgModeButtons();
                colorSetting.style.display = 'block';
                imageSetting.style.display = 'none';
            });

            imageModeButton.addEventListener('click', function() {
                setBgMode('image');
                updateBgModeButtons();
                colorSetting.style.display = 'none';
                imageSetting.style.display = 'block';
            });
        }

        function updateBgModeButtons() {
            const colorModeButton = document.getElementById('bg-mode-color');
            const imageModeButton = document.getElementById('bg-mode-image');
            
            colorModeButton.classList.toggle('active', bgMode === 'color');
            imageModeButton.classList.toggle('active', bgMode === 'image');
        }

        function setBgMode(mode) {
            bgMode = mode;
            applyBackground();
            saveBgSettings();
        }

        function setupBgImageOptions() {
            const bgImageOptions = document.querySelectorAll('#bg-image-options .bg-image-option');
            
            bgImageOptions.forEach(option => {
                // 設定初始狀態
                if (option.getAttribute('data-image') === bgImage) {
                    option.classList.add('active');
                } else {
                    option.classList.remove('active');
                }

                option.addEventListener('click', function() {
                    // 移除其他選項的active類
                    bgImageOptions.forEach(opt => opt.classList.remove('active'));
                    this.classList.add('active');

                    const imageType = this.getAttribute('data-image');
                    setBgImage(imageType);
                });
            });
        }

        function setBgImage(imageType) {
            bgImage = imageType;
            if (imageType !== 'custom') {
                customBgImage = null; // 清除自訂圖片
                document.getElementById('bg-image-preview-container').style.display = 'none';
            }
            applyBackground();
            saveBgSettings();
        }

        function applyBackground() {
            const gameContainer = document.querySelector('.game-container');
            const homeScreen = document.querySelector('.home-screen');
            
            if (bgMode === 'color') {
                // 使用顏色背景
                const gradientColor = `linear-gradient(135deg, ${bgColor}, ${adjustColor(bgColor, -20)})`;
                gameContainer.style.background = gradientColor;
                if (homeScreen) homeScreen.style.background = gradientColor;
            } else {
                // 使用圖片背景
                let backgroundStyle = '';
                
                if (bgImage === 'none') {
                    backgroundStyle = `linear-gradient(135deg, ${bgColor}, ${adjustColor(bgColor, -20)})`;
                } else if (bgImage === 'custom' && customBgImage) {
                    backgroundStyle = `linear-gradient(rgba(0,0,0,${1-bgOpacity}), rgba(0,0,0,${1-bgOpacity})), url(${customBgImage})`;
                } else {
                    // 預設圖片背景
                    const bgClass = bgImage + '-bg';
                    const tempDiv = document.createElement('div');
                    tempDiv.className = bgClass;
                    document.body.appendChild(tempDiv);
                    const computedStyle = getComputedStyle(tempDiv);
                    const bgValue = computedStyle.backgroundImage || computedStyle.background;
                    document.body.removeChild(tempDiv);
                    
                    backgroundStyle = `linear-gradient(rgba(0,0,0,${1-bgOpacity}), rgba(0,0,0,${1-bgOpacity})), ${bgValue}`;
                }
                
                gameContainer.style.background = backgroundStyle;
                gameContainer.style.backgroundSize = 'cover';
                gameContainer.style.backgroundPosition = 'center';
                gameContainer.style.backgroundRepeat = 'no-repeat';
                
                if (homeScreen) {
                    homeScreen.style.background = backgroundStyle;
                    homeScreen.style.backgroundSize = 'cover';
                    homeScreen.style.backgroundPosition = 'center';
                    homeScreen.style.backgroundRepeat = 'no-repeat';
                }
            }
        }

        function setupBgOpacityControl() {
            const opacityControl = document.getElementById('bg-opacity-control');
            const opacityValue = document.getElementById('bg-opacity-value');
            
            opacityControl.addEventListener('input', function() {
                bgOpacity = parseFloat(this.value);
                opacityValue.textContent = Math.round(bgOpacity * 100) + '%';
                if (bgMode === 'image') {
                    applyBackground();
                }
                saveBgSettings();
            });
            
            // 設定初始值
            opacityControl.value = bgOpacity;
            opacityValue.textContent = Math.round(bgOpacity * 100) + '%';
        }

        function setupBgImageUpload() {
            const uploadBtn = document.getElementById('bg-image-upload-btn');
            const fileInput = document.getElementById('bg-image-file');
            const previewContainer = document.getElementById('bg-image-preview-container');
            const previewImg = document.getElementById('bg-image-preview');
            const removeBtn = document.getElementById('bg-image-remove');

            uploadBtn.addEventListener('click', function() {
                fileInput.click();
            });

            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    // 檢查檔案大小 (限制為2MB)
                    if (file.size > 2 * 1024 * 1024) {
                        alert('圖片檔案過大，請選擇小於2MB的圖片');
                        return;
                    }
                    
                    // 檢查檔案類型
                    if (!file.type.startsWith('image/')) {
                        alert('請選擇有效的圖片檔案');
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = function(e) {
                        customBgImage = e.target.result;
                        previewImg.src = customBgImage;
                        previewContainer.style.display = 'block';
                        
                        // 設定為自訂圖片
                        document.querySelectorAll('#bg-image-options .bg-image-option').forEach(opt => {
                            opt.classList.remove('active');
                        });
                        setBgImage('custom');
                    };
                    reader.readAsDataURL(file);
                }
            });

            removeBtn.addEventListener('click', function() {
                customBgImage = null;
                previewContainer.style.display = 'none';
                fileInput.value = '';
                setBgImage('none');
            });
        }

        function saveBgSettings() {
            try {
                localStorage.setItem('shootingGameBgMode', bgMode);
                localStorage.setItem('shootingGameBgImage', bgImage);
                localStorage.setItem('shootingGameBgOpacity', bgOpacity.toString());
                if (customBgImage) {
                    localStorage.setItem('shootingGameCustomBgImage', customBgImage);
                } else {
                    localStorage.removeItem('shootingGameCustomBgImage');
                }
            } catch (e) {
                console.error('保存背景設定失敗:', e);
            }
        }

        function loadBgSettings() {
            try {
                const savedBgMode = localStorage.getItem('shootingGameBgMode');
                const savedBgImage = localStorage.getItem('shootingGameBgImage');
                const savedBgOpacity = localStorage.getItem('shootingGameBgOpacity');
                const savedCustomBgImage = localStorage.getItem('shootingGameCustomBgImage');
                
                if (savedBgMode) {
                    bgMode = savedBgMode;
                }
                
                if (savedBgImage) {
                    bgImage = savedBgImage;
                }
                
                if (savedBgOpacity) {
                    bgOpacity = parseFloat(savedBgOpacity);
                }
                
                if (savedCustomBgImage) {
                    customBgImage = savedCustomBgImage;
                    document.getElementById('bg-image-preview').src = customBgImage;
                    document.getElementById('bg-image-preview-container').style.display = 'block';
                }

                // 更新UI
                updateBgModeButtons();
                const colorSetting = document.getElementById('bg-color-setting');
                const imageSetting = document.getElementById('bg-image-setting');
                
                if (bgMode === 'color') {
                    colorSetting.style.display = 'block';
                    imageSetting.style.display = 'none';
                } else {
                    colorSetting.style.display = 'none';
                    imageSetting.style.display = 'block';
                }
                
                setupBgImageOptions(); // 更新圖片選項的active狀態
                setupBgOpacityControl(); // 更新透明度控制
                applyBackground();
            } catch (e) {
                console.error('載入背景設定失敗:', e);
            }
        }

        function setupColorOptions() {

            const bgColorOptions = document.querySelectorAll('#bg-color-options .color-option');
            bgColorOptions.forEach(option => {

                if (option.getAttribute('data-color') === bgColor) {
                    option.classList.add('active');
                } else {
                    option.classList.remove('active');
                }

                option.addEventListener('click', function() {

                    bgColorOptions.forEach(opt => opt.classList.remove('active'));
                    this.classList.add('active');

                    const color = this.getAttribute('data-color');

                    setBgColor(color);

                    document.getElementById('bg-color-custom').value = color;
                });
            });

            const targetColorOptions = document.querySelectorAll('#target-color-options .color-option');
            targetColorOptions.forEach(option => {

                if (option.getAttribute('data-color') === targetColor) {
                    option.classList.add('active');
                } else {
                    option.classList.remove('active');
                }

                option.addEventListener('click', function() {

                    targetColorOptions.forEach(opt => opt.classList.remove('active'));
                    this.classList.add('active');

                    const color = this.getAttribute('data-color');

                    setTargetColor(color);

                    document.getElementById('target-color-custom').value = color;
                });
            });

            document.getElementById('bg-color-apply').addEventListener('click', function() {
                const customColor = document.getElementById('bg-color-custom').value;

                bgColorOptions.forEach(opt => opt.classList.remove('active'));

                let matchFound = false;
                bgColorOptions.forEach(opt => {
                    if (opt.getAttribute('data-color') === customColor) {
                        opt.classList.add('active');
                        matchFound = true;
                    }
                });

                setBgColor(customColor);
            });

            document.getElementById('target-color-apply').addEventListener('click', function() {
                const customColor = document.getElementById('target-color-custom').value;

                targetColorOptions.forEach(opt => opt.classList.remove('active'));

                let matchFound = false;
                targetColorOptions.forEach(opt => {
                    if (opt.getAttribute('data-color') === customColor) {
                        opt.classList.add('active');
                        matchFound = true;
                    }
                });

                setTargetColor(customColor);
            });

            document.getElementById('bg-color-custom').value = bgColor;
            document.getElementById('target-color-custom').value = targetColor;
        }

        function setBgColor(color) {
            bgColor = color;
            if (bgMode === 'color') {
                applyBackground();
            }
            saveColorSettings();
        }

        function setTargetColor(color) {
            targetColor = color;

            const target = getTarget();
            if (gameMode === "human") {
                document.querySelectorAll('.head, .body, .arm-left, .arm-right, .leg-left, .leg-right').forEach(el => {
                    el.style.backgroundColor = color;
                });
            } else {
                if (target) {
                    target.style.background = `radial-gradient(circle, white 10%, ${color} 10%, ${color} 30%, white 30%, white 50%, ${adjustColor(color, -20)} 50%, ${adjustColor(color, -20)} 70%, white 70%)`;
                }
            }

            saveColorSettings();
        }

        function saveColorSettings() {
            try {
                localStorage.setItem('shootingGameBgColor', bgColor);
                localStorage.setItem('shootingGameTargetColor', targetColor);
                saveBgSettings(); // 同時保存背景設定
            } catch (e) {
                console.error('保存顏色設定失敗:', e);
            }
        }

        function loadColorSettings() {
            try {
                const savedBgColor = localStorage.getItem('shootingGameBgColor');
                const savedTargetColor = localStorage.getItem('shootingGameTargetColor');
                
                if (savedBgColor) {
                    bgColor = savedBgColor;
                }
                
                if (savedTargetColor) {
                    targetColor = savedTargetColor;
                }

                loadBgSettings(); // 載入背景設定
                setTargetColor(targetColor);
            } catch (e) {
                console.error('載入顏色設定失敗:', e);
            }
        }

        function adjustColor(color, amount) {
            let r = parseInt(color.substring(1, 3), 16);
            let g = parseInt(color.substring(3, 5), 16);
            let b = parseInt(color.substring(5, 7), 16);

            r = Math.max(0, Math.min(255, r + amount));
            g = Math.max(0, Math.min(255, g + amount));
            b = Math.max(0, Math.min(255, b + amount));

            return '#' + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
        }
        

        function setMoveType(type) {
            moveType = type;
            console.log(`移動方式已設置為: ${type}`);

            const moveTypeDisplay = document.getElementById('current-move-type');
            if (moveTypeDisplay) {
                moveTypeDisplay.textContent = type === 'transition' ? '漸變移動' : '瞬間移動';
            } else {
                console.error('找不到移動方式顯示元素');
            }

            if (isPlaying) {
                const targetElement = getTarget();
                if (targetElement) {
                    targetElement.style.transition = type === 'transition' 
                        ? `left ${difficulties[currentDifficulty].targetSpeed}ms, top ${difficulties[currentDifficulty].targetSpeed}ms`
                        : 'none';
                }
            }
        }

        function setMoveTrigger(trigger) {
            moveTrigger = trigger;
            console.log(`移動觸發方式已設置為: ${trigger}`);

            const moveTriggerDisplay = document.getElementById('current-move-trigger');
            if (moveTriggerDisplay) {
                let displayText = '手動移動';
                if (trigger === 'auto') {
                    displayText = '自動連續';
                } else if (trigger === 'continuous') {
                    displayText = '持續移動';
                }
                moveTriggerDisplay.textContent = displayText;
            } else {
                console.error('找不到移動觸發方式顯示元素');
            }

            // 如果遊戲正在進行中，需要調整移動邏輯
            if (isPlaying && !isPaused) {
                if (trigger === 'auto') {
                    // 啟動自動移動
                    startAutoMovement();
                } else if (trigger === 'continuous') {
                    // 啟動持續移動
                    startContinuousMovement();
                } else {
                    // 停止自動移動和持續移動
                    stopContinuousMovement();
                    stopContinuousMovement();
                }
            }
        }



        document.addEventListener('DOMContentLoaded', function() {

            document.addEventListener('selectstart', function(e) {
                e.preventDefault();
            });

            document.addEventListener('dragstart', function(e) {
                e.preventDefault();
            });

            initSounds();

            setTimeout(() => {

                const shotSound = document.getElementById('sound-shot');
                if (shotSound && shotSound.src) {
                    console.log('射擊音效已載入:', shotSound.src);

                    shotSound.load();
                } else {
                    console.error('找不到射擊音效元素或其源文件');
                }
            }, 500); 

            loadColorSettings();
            
            // 載入玩家名稱
            loadPlayerName();

            initGame();

            setupColorOptions();
            
            // 設定背景相關功能
            setupBgModeButtons();
            setupBgImageOptions();
            setupBgOpacityControl();
            setupBgImageUpload();

            adjustGameContainerSize();

            window.addEventListener('resize', adjustGameContainerSize);

            showHome();

            setTimeout(setupMoveTypeButtons, 500);
            setTimeout(setupMoveTriggerButtons, 500);

            // 設定按鈕事件監聽器
            document.getElementById('settings-button').addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('設定按鈕被點擊');
                const settingsPanel = document.getElementById('settings-panel');
                settingsPanel.classList.toggle('show-settings');
                console.log('設定面板顯示狀態:', settingsPanel.classList.contains('show-settings'));

                if (settingsPanel.classList.contains('show-settings')) {
                    setupMoveTypeButtons();
                    setupMoveTriggerButtons();
                    // 確保背景設定UI正確顯示
                    updateBgModeButtons();
                    const colorSetting = document.getElementById('bg-color-setting');
                    const imageSetting = document.getElementById('bg-image-setting');
                    
                    if (bgMode === 'color') {
                        colorSetting.style.display = 'block';
                        imageSetting.style.display = 'none';
                    } else {
                        colorSetting.style.display = 'none';
                        imageSetting.style.display = 'block';
                    }
                    setupColorOptions();
                }
            });

            // 其他設定相關的事件監聽器
            document.getElementById('close-settings').addEventListener('click', function() {
                document.getElementById('settings-panel').classList.remove('show-settings');
            });

            document.getElementById('easy-button').addEventListener('click', function() {
                setDifficulty('easy');
                updateDifficultyButtons('easy');
            });

            document.getElementById('medium-button').addEventListener('click', function() {
                setDifficulty('medium');
                updateDifficultyButtons('medium');
            });

            document.getElementById('hard-button').addEventListener('click', function() {
                setDifficulty('hard');
                updateDifficultyButtons('hard');
            });

            document.getElementById('volume-control').addEventListener('input', function(e) {
                soundSettings.volume = parseFloat(e.target.value);
                Object.values(sounds).forEach(sound => {
                    sound.volume = soundSettings.volume;
                });
            });

            document.getElementById('mute-toggle').addEventListener('change', function(e) {
                soundSettings.muted = e.target.checked;
                Object.values(sounds).forEach(sound => {
                    sound.muted = soundSettings.muted;
                });
            });

            // 暫停和恢復遊戲的事件監聽器
            document.getElementById('resume-button').addEventListener('click', resumeGame);
            document.getElementById('pause-end-game').addEventListener('click', endGame);

            // 主要按鈕事件監聽器
            playButton.addEventListener('click', showStartScreen);
            startButton.addEventListener('click', startGame);
            restartButton.addEventListener('click', startGame);
            homeButton.addEventListener('click', showHome);
            backToHomeButton.addEventListener('click', showHome);
            document.getElementById('end-game-button').addEventListener('click', endGame);
            instructionsButton.addEventListener('click', showInstructions);
            backFromInstructionsButton.addEventListener('click', showHome);

            // 排行榜事件監聽器
            leaderboardButton.addEventListener('click', function() {
                homeScreen.style.display = 'none';
                leaderboardScreen.style.display = 'flex';
                loadLeaderboard('all');
            });

            closeLeaderboardButton.addEventListener('click', function() {
                leaderboardScreen.style.display = 'none';
                homeScreen.style.display = 'flex';
            });

            // 篩選按鈕事件監聽器
            document.getElementById('filter-all').addEventListener('click', function() {
                setActiveFilter('filter-all');
                loadLeaderboard('all');
            });

            document.getElementById('filter-human').addEventListener('click', function() {
                setActiveFilter('filter-human');
                loadLeaderboard('human');
            });

            document.getElementById('filter-circle').addEventListener('click', function() {
                setActiveFilter('filter-circle');
                loadLeaderboard('circle');
            });

            document.getElementById('filter-today').addEventListener('click', function() {
                setActiveFilter('filter-today');
                loadLeaderboard('today');
            });

            // 暫停遊戲按鈕
            document.getElementById('pause-game-button').addEventListener('click', function() {
                if (isPaused) {
                    resumeGame();
                } else {
                    pauseGame();
                }
            });

            // 鍵盤事件監聽器
            document.addEventListener('keydown', function(e) {
                if (e.code === 'Space' || e.key === ' ') {
                    e.preventDefault();
                    if (isPlaying && !isPaused) {
                        pauseGame();
                    }
                }
                if (e.key === 'Escape' && isPlaying) {
                    endGame();
                }
            });

            // 模式切換按鈕
            homeToggleModeButton.addEventListener('click', toggleGameMode);

            console.log('遊戲初始化完成');
        });

        function adjustGameContainerSize() {

            gameContainer.style.width = `${window.innerWidth}px`;
            gameContainer.style.height = `${window.innerHeight}px`;

            document.body.style.overflow = 'hidden';
            document.documentElement.style.overflow = 'hidden';

            document.body.style.webkitTouchCallout = 'none'; 
            document.body.style.webkitUserSelect = 'none';   
            document.body.style.khtmlUserSelect = 'none';    
            document.body.style.mozUserSelect = 'none';      
            document.body.style.msUserSelect = 'none';       
            document.body.style.userSelect = 'none';         

            if (isPlaying && !isPaused) {
                placeTargetRandomly();
            }
        }

        function setupMoveTypeButtons() {

            function updateMoveTypeButtons(activeType) {
                document.querySelectorAll('.move-type-buttons .move-button').forEach(button => {
                    button.classList.remove('active');
                });
                document.getElementById(`${activeType}-move`).classList.add('active');
            }

            const transitionButton = document.getElementById('transition-move');
            const instantButton = document.getElementById('instant-move');
            
            if (transitionButton && instantButton) {

                transitionButton.addEventListener('click', function() {
                    setMoveType('transition');
                    updateMoveTypeButtons('transition');
                    console.log('設置為漸變移動');
                });
                
                instantButton.addEventListener('click', function() {
                    setMoveType('instant');
                    updateMoveTypeButtons('instant');
                    console.log('設置為瞬間移動');
                });
            } else {
                console.error('找不到移動方式按鈕');
            }
        }

        function setupMoveTriggerButtons() {

            function updateMoveTriggerButtons(activeTrigger) {
                document.querySelectorAll('.move-trigger-buttons .move-button').forEach(button => {
                    button.classList.remove('active');
                });
                document.getElementById(`${activeTrigger}-move`).classList.add('active');
            }

            const manualButton = document.getElementById('manual-move');
            const autoButton = document.getElementById('auto-move');
            const continuousButton = document.getElementById('continuous-move');
            
            if (manualButton && autoButton && continuousButton) {

                manualButton.addEventListener('click', function() {
                    setMoveTrigger('manual');
                    updateMoveTriggerButtons('manual');
                    console.log('設置為手動移動');
                });
                
                autoButton.addEventListener('click', function() {
                    setMoveTrigger('auto');
                    updateMoveTriggerButtons('auto');
                    console.log('設置為自動連續移動');
                });
                
                continuousButton.addEventListener('click', function() {
                    setMoveTrigger('continuous');
                    updateMoveTriggerButtons('continuous');
                    console.log('設置為持續移動');
                });
            } else {
                console.error('找不到移動觸發方式按鈕');
            }
        }

        function placeTargetRandomly() {
            const target = getTarget();
            if (!target) return;

            const gameContainer = document.getElementById('game-container');
            const containerWidth = gameContainer.clientWidth;
            const containerHeight = gameContainer.clientHeight;

            const targetWidth = target.offsetWidth;
            const targetHeight = target.offsetHeight;

            const maxX = containerWidth - targetWidth;
            const maxY = containerHeight - targetHeight;

            const minY = 70; 

            let randomX = Math.floor(Math.random() * maxX);
            let randomY = Math.floor(Math.random() * (maxY - minY)) + minY;

            if (moveType === 'transition') {
                target.style.transition = `left ${difficulties[currentDifficulty].targetSpeed}ms, top ${difficulties[currentDifficulty].targetSpeed}ms`;
            } else {
                target.style.transition = 'none';
            }

            target.style.left = `${randomX}px`;
            target.style.top = `${randomY}px`;
        }

        // 持續移動相關函數
        function startAutoMovement() {
            if (movingInterval) {
                clearInterval(movingInterval);
            }
            
            // 根據難度設定移動間隔
            const moveIntervals = {
                easy: { min: 3000, max: 5000 },    // 3-5秒
                medium: { min: 2000, max: 4000 },  // 2-4秒
                hard: { min: 1000, max: 3000 }     // 1-3秒
            };
            
            function scheduleNextMove() {
                const interval = moveIntervals[currentDifficulty];
                const randomDelay = Math.random() * (interval.max - interval.min) + interval.min;
                
                movingInterval = setTimeout(() => {
                    if (isPlaying && !isPaused && moveTrigger === 'auto') {
                        placeTargetRandomly();
                        scheduleNextMove(); // 安排下一次移動
                    }
                }, randomDelay);
            }
            
            scheduleNextMove();
        }

        function stopContinuousMovement() {
            if (movingInterval) {
                clearTimeout(movingInterval);
                movingInterval = null;
            }
        }

        // 持續移動模式函數 - 真正的持續不間斷移動
        let continuousMovementActive = false;
        let continuousMovementCount = 0;
        let lastContinuousMove = 0;
        
        function startContinuousMovement() {
            console.log('啟動持續移動模式');
            
            // 停止之前的計時器
            stopContinuousMovement();
            
            // 標記持續移動為啟用狀態
            continuousMovementActive = true;
            continuousMovementCount = 0;
            
            // 優化的移動間隔 - 更短更頻繁
            const moveIntervals = {
                easy: 1000,   // 1秒
                medium: 800,  // 0.8秒  
                hard: 600     // 0.6秒
            };
            
            const interval = moveIntervals[currentDifficulty];
            console.log(`持續移動間隔設定為: ${interval}ms`);
            
            // 立即進行第一次移動
            if (isPlaying && !isPaused && moveTrigger === 'continuous') {
                placeTargetRandomly();
                continuousMovementCount++;
                lastContinuousMove = Date.now();
            }
            
            // 設定持續移動計時器
            continuousInterval = setInterval(() => {
                if (continuousMovementActive && isPlaying && !isPaused && moveTrigger === 'continuous') {
                    placeTargetRandomly();
                    continuousMovementCount++;
                    lastContinuousMove = Date.now();
                    console.log(`持續移動次數: ${continuousMovementCount}`);
                } else if (!continuousMovementActive || moveTrigger !== 'continuous') {
                    // 如果不應該持續移動了，停止計時器
                    console.log('停止持續移動 - 狀態變更');
                    stopContinuousMovement();
                }
            }, interval);
            
            // 設定監控計時器 - 每3秒檢查一次計時器健康狀況
            setTimeout(monitorContinuousMovement, 3000);
        }
        
        function monitorContinuousMovement() {
            if (!continuousMovementActive || moveTrigger !== 'continuous') {
                return; // 不需要監控了
            }
            
            const now = Date.now();
            const timeSinceLastMove = now - lastContinuousMove;
            
            // 如果超過3秒沒有移動，重啟計時器
            if (timeSinceLastMove > 3000) {
                console.log('檢測到持續移動停滯，重啟計時器');
                startContinuousMovement();
            } else {
                // 持續監控
                setTimeout(monitorContinuousMovement, 3000);
            }
        }

        function stopContinuousMovement() {
            console.log('停止持續移動模式');
            continuousMovementActive = false;
            
            if (continuousInterval) {
                clearInterval(continuousInterval);
                continuousInterval = null;
            }
            
            console.log(`持續移動總次數: ${continuousMovementCount}`);
        }

        function getMovingModeIntervalRange() {
            const moveIntervals = {
                easy: "3-5秒",
                medium: "2-4秒", 
                hard: "1-3秒"
            };
            return moveIntervals[currentDifficulty] || "2-4秒";
        }
        
        function getContinuousModeIntervalRange() {
            const moveIntervals = {
                easy: "1秒",
                medium: "0.8秒", 
                hard: "0.6秒"
            };
            return moveIntervals[currentDifficulty] || "0.8秒";
        }
    </script>
</body>
</html>
